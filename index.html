<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üë™ Family Calendar</title>

  <!-- FullCalendar (month + timeGrid day) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      padding: 16px 16px 24px;
      max-width: 980px;
      margin: 0 auto;
    }
    h2 { margin: 0 0 16px; display:flex; align-items:center; gap:8px; }
    #calendar { margin-top: 16px; }
    .fc-event { cursor: pointer; }

    /* Auth + form panels */
    .panel { background:#f7f7f7; border-radius:12px; padding:12px; margin:12px 0; }
    .panel h3 { margin:0 0 8px; font-size:16px; }
    input[type="email"], input[type="password"],
    input[type="text"], input[type="date"] {
      width:100%; padding:10px; font-size:16px; margin:6px 0; border:1px solid #dadde1; border-radius:10px;
    }
    button {
      appearance: none; border:0; border-radius:10px; padding:10px 14px; font-size:16px;
      background:#1f6feb; color:#fff; cursor:pointer;
    }
    button.secondary { background:#e5e7eb; color:#111827; }
    button.ghost { background:#fff; border:1px solid #dadde1; color:#111827; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > button { flex:1; min-width: 140px; }

    /* Show/hide auth bits based on body class */
    body.logged-in  .only-when-logged-out { display:none !important; }
    body.logged-out .only-when-logged-in  { display:none !important; }

    #status { margin:6px 0 2px; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }
    .muted { color:var(--muted); }

    /* Toolbar above the calendar */
    #toolbar { display:flex; gap:8px; justify-content:flex-end; margin:8px 0 2px; }

    /* Footer */
    footer { margin-top: 16px; font-size: 14px; color:#374151; display:flex; gap:16px; flex-wrap:wrap; }
    kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; }

    /* Small helpers */
    .hidden { display:none !important; }
    .link { color:#2563eb; text-decoration: none; }
    .link:hover { text-decoration: underline; }
  </style>
</head>
<body class="logged-out">
  <h2>üë™ Family Calendar</h2>

  <!-- Auth section -->
  <div id="auth-section" class="panel">
    <div class="only-when-logged-out">
      <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
      <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
      <div class="row">
        <button id="btn-signup"  class="ghost">Sign Up</button>
        <button id="btn-login">Log In</button>
        <button id="btn-google" class="secondary">Sign in with Google</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="only-when-logged-in muted" style="flex:1; display:flex; align-items:center; padding:10px 0;">
        <span id="auth-hello">Welcome</span>
      </div>
      <button id="btn-logout" class="secondary only-when-logged-in" style="min-width:140px;">Log Out</button>
    </div>
    <p id="auth-status" class="muted" style="margin:4px 0 0;"></p>
  </div>

  <!-- Status line -->
  <div id="status" class="hidden" aria-live="polite"></div>

  <!-- Event form -->
  <div id="event-form" class="panel only-when-logged-in">
    <h3>Add / Edit Event</h3>
    <input type="hidden" id="event-id">
    <label>Title:</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">
    <div class="row">
      <div style="flex:1">
        <label>Start Date:</label>
        <input type="date" id="event-date-start">
      </div>
      <div style="flex:1">
        <label>End Date (optional, inclusive):</label>
        <input type="date" id="event-date-end">
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="btn-save">Save</button>
      <button id="btn-cancel" class="secondary">Cancel</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div id="toolbar" class="only-when-logged-in">
    <button id="btn-refresh" class="ghost">Refresh</button>
    <button id="btn-month"   class="ghost hidden">Month</button>
    <button id="btn-day"     class="ghost hidden">Day</button>
  </div>

  <!-- Calendar -->
  <div id="calendar"></div>

  <footer>
    <span>Version: <kbd id="v"></kbd></span>
    <span>Deployed: <kbd id="d"></kbd></span>
  </footer>

  <!-- Firebase + App -->
  <script type="module">
    /*******************
     * CONFIG + GLOBALS
     *******************/
    const APP_VERSION = "v1.1.0"; // <-- bump when you ship
    const isIOS    = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // Version footer
    const fmtLocal = (d) => {
      try {
        return new Intl.DateTimeFormat(undefined, {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);
      } catch { return d.toISOString().slice(0,16); }
    };
    (document.getElementById("v").textContent = APP_VERSION);
    (document.getElementById("d").textContent = fmtLocal(new Date()));

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const authStatusEl = $("auth-status");
    const helloEl = $("auth-hello");

    function setBodyState(loggedIn) {
      document.body.classList.toggle("logged-in",  loggedIn);
      document.body.classList.toggle("logged-out", !loggedIn);
    }
    function toast(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.className = ok? "ok" : "err";
      statusEl.classList.remove("hidden");
      setTimeout(()=>statusEl.classList.add("hidden"), ok? 2000: 6000);
    }

    /*******************
     * FULLCALENDAR
     *******************/
    let calendar;
    let currentView = "dayGridMonth";

    function toExclusiveEnd(inclusiveYMD) {
      // all-day exclusive end required by FullCalendar
      const d = new Date(inclusiveYMD + "T00:00:00");
      d.setDate(d.getDate() + 1);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function goMonth() {
      currentView = "dayGridMonth";
      calendar.changeView("dayGridMonth");
      $("btn-day").classList.remove("hidden");
      $("btn-month").classList.add("hidden");
    }
    function goDay(dateStr) {
      currentView = "timeGridDay";
      calendar.changeView("timeGridDay", dateStr);
      $("btn-month").classList.remove("hidden");
      $("btn-day").classList.add("hidden");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Handle Google redirect result (iOS/Safari)
      try {
        const res = await getRedirectResult(auth);
        if (res?.user) {
          authStatusEl.textContent = "Welcome, " + (res.user.email || "");
          toast("Logged in with Google.", true);
        }
      } catch(e) { if (e?.message) toast(e.message, false); }

      calendar = new FullCalendar.Calendar($("calendar"), {
        initialView: "dayGridMonth",
        headerToolbar: false,
        height: "auto",
        dateClick: (info) => {
          if (!auth.currentUser) { toast("Please log in to add events.", false); return; }
          // Jump into timeGrid day view when you tap a date
          goDay(info.dateStr);
          // Prefill form
          $("event-id").value = "";
          $("event-title").value = "";
          $("event-date-start").value = info.dateStr;
          $("event-date-end").value = info.dateStr;
          $("event-title").focus();
        },
        eventClick: (info) => {
          // Jump to that day first
          const y = info.event.start;
          const ymd = `${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,'0')}-${String(y.getDate()).padStart(2,'0')}`;
          goDay(ymd);

          // Delete confirm
          if (!auth.currentUser) { toast("Please log in to delete.", false); return; }
          const t = info.event.title || "(no title)";
          if (confirm(`Delete ‚Äú${t}‚Äù?`)) {
            remove(ref(db, "events/" + info.event.id))
              .then(() => { info.event.remove(); toast("Deleted.", true); })
              .catch((e) => toast(e.message, false));
          }
        }
      });
      calendar.render();

      // Toolbar buttons
      $("btn-refresh").onclick = () => loadEvents(false);
      $("btn-month").onclick   = () => goMonth();
      $("btn-day").onclick     = () => goDay(calendar.getDate().toISOString().slice(0,10));
    });

    /*******************
     * AUTH HANDLERS
     *******************/
    $("btn-signup").onclick = () => {
      const email = $("auth-email").value.trim();
      const pass  = $("auth-password").value;
      createUserWithEmailAndPassword(auth, email, pass)
        .then((u)=>{ authStatusEl.textContent = "Signed up as " + (u.user.email||""); toast("Signed up.", true); })
        .catch((e)=>{ authStatusEl.textContent = e.message; toast(e.message, false); });
    };

    $("btn-login").onclick = () => {
      const email = $("auth-email").value.trim();
      const pass  = $("auth-password").value;
      signInWithEmailAndPassword(auth, email, pass)
        .then((u)=>{ authStatusEl.textContent = "Welcome, " + (u.user.email||""); toast("Logged in.", true); })
        .catch((e)=>{ authStatusEl.textContent = e.message; toast(e.message, false); });
    };

    $("btn-google").onclick = async () => {
      try {
        if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else { await signInWithPopup(auth, googleProvider); toast("Logged in with Google.", true); }
      } catch (e) {
        if (e?.code === "auth/popup-blocked") {
          try { await signInWithRedirect(auth, googleProvider); }
          catch (err) { toast(err.message, false); }
        } else toast(e.message, false);
      }
    };

    $("btn-logout").onclick = () => {
      signOut(auth).then(()=>{
        authStatusEl.textContent = "Logged out.";
        toast("Logged out.", true);
        calendar.removeAllEvents();
        goMonth();
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        setBodyState(true);
        helloEl.textContent = "Welcome, " + (user.email || "");
        loadEvents(true);
      } else {
        setBodyState(false);
        authStatusEl.textContent = "";
        calendar && calendar.removeAllEvents();
        goMonth();
      }
    });

    /*******************
     * CRUD
     *******************/
    $("btn-save").onclick = () => {
      if (!auth.currentUser) { toast("Please log in to save.", false); return; }
      const id    = $("event-id").value || Date.now().toString();
      const title = $("event-title").value.trim();
      const start = $("event-date-start").value;
      const endIncl = $("event-date-end").value;

      if (!title || !start) { toast("Title and start date are required.", false); return; }

      const payload = { id, title, start, allDay: true };
      if (endIncl && endIncl >= start) payload.end = toExclusiveEnd(endIncl);

      set(ref(db, "events/" + id), payload)
        .then(()=>{ toast("Saved!", true); loadEvents(false); })
        .catch((e)=> toast(e.message, false));
    };
    $("btn-cancel").onclick = () => { $("event-title").value = ""; };

    function normalizeEvent(o) {
      const start = o.start || o.date;
      const e = { id: o.id, title: o.title, start, allDay: true };
      if (o.end) e.end = o.end;
      return e;
    }
    function validEvent(e) {
      if (!e || typeof e.title !== "string" || !e.title.trim()) return false;
      if (typeof e.start !== "string" || !/^\d{4}-\d{2}-\d{2}$/.test(e.start)) return false;
      if (e.end && !/^\d{4}-\d{2}-\d{2}$/.test(e.end)) return false;
      return true;
    }

    async function loadEvents(initial) {
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const raw  = Object.values(data);
        const list = [];
        let ok=0, bad=0;
        for (const r of raw) {
          const e = normalizeEvent(r);
          if (validEvent(e)) { list.push(e); ok++; } else bad++;
        }
        calendar.removeAllEvents();
        calendar.addEventSource(list);

        toast(`Loaded ${ok} event(s)` + (bad? `, skipped ${bad}`:""), true);
      } catch(e) {
        toast(e.message || "Failed to load.", false);
      }
    }

    // Expose a debug helper (optional)
    window.testSpan = function() {
      const id = "sample-trip";
      set(ref(db,"events/"+id), { id, title:"Trip", start:"2025-08-10", end:"2025-08-17", allDay:true });
    };

    /*******************
     * PWA SW register (safe-noise)
     *******************/
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{/* ignore */});
      });
    }
  </script>
</body>
</html>