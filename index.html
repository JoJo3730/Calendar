<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --muted:#6b7280; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding: 20px; }
    h2 { margin: 0 0 16px; }
    #calendar { max-width: 1000px; margin: 16px auto; }
    .fc-event { cursor: pointer; }

    /* Auth */
    #auth-section input { width:100%; padding:10px; font-size:16px; margin:6px 0; box-sizing:border-box; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > button { flex:1; min-width: 140px; }
    .hidden { display:none !important; }

    /* Form */
    #event-form { background:#f5f5f5; padding:12px; border-radius:8px; margin:16px auto; max-width:1000px; }
    label { display:block; margin-top:8px; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"], select, button { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .inline { display:flex; gap:8px; align-items:center; }
    .form-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .muted { color:var(--muted); font-size:12px; margin-top:2px; }

    /* Status + toolbar */
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }
    #toolbar { display:flex; gap:8px; justify-content:flex-end; margin:8px auto; max-width:1000px; }
    #btn-google { background:#fff; border:1px solid #dadce0; }

    /* Tiny color dot in select */
    .who-option { padding-left:28px; position:relative; }
    .who-option::before { content:""; position:absolute; left:8px; top:50%; transform:translateY(-50%); width:12px; height:12px; border-radius:50%; }
  </style>
</head>
<body>
  <h2>ðŸ‘ª Family Calendar</h2>

  <!-- Auth block (hidden after login) -->
  <div id="auth-section">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="btn-signup">Sign Up</button>
      <button id="btn-login">Log In</button>
      <button id="btn-google">Sign in with Google</button>
      <button id="btn-logout">Log Out</button>
    </div>
    <p id="auth-status"></p>
  </div>

  <div id="status" class="hidden"></div>

  <!-- Event form -->
  <div id="event-form" class="hidden">
    <input type="hidden" id="event-id">

    <label>Title</label>
    <input type="text" id="event-title" placeholder="e.g., Dentist, Practice, Dinner">

    <label>Who</label>
    <select id="event-who"></select>
    <div class="muted">Pick a person to color-code the event.</div>

    <div class="inline" style="margin-top:8px;">
      <input type="checkbox" id="event-all-day" checked>
      <label for="event-all-day" style="margin:0;">All day</label>
    </div>

    <label>Start Date</label>
    <input type="date" id="event-date-start">

    <div id="time-start-wrap" class="hidden">
      <label>Start Time</label>
      <input type="time" id="event-time-start" value="09:00">
    </div>

    <label>End Date (optional, inclusive for all-day)</label>
    <input type="date" id="event-date-end">

    <div id="time-end-wrap" class="hidden">
      <label>End Time (optional)</label>
      <input type="time" id="event-time-end" value="10:00">
    </div>

    <div class="form-actions">
      <button id="btn-save">Save</button>
      <button id="btn-cancel" type="button">Cancel</button>
      <button id="btn-delete" class="hidden" type="button">Delete</button>
    </div>
  </div>

  <!-- Toolbar (visible after login) -->
  <div id="toolbar" class="hidden">
    <button id="btn-refresh">Refresh</button>
    <button id="btn-back-month">Back to Month</button>
    <button id="btn-logout-toolbar">Log Out</button>
  </div>

  <div id="calendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    const el = (id) => document.getElementById(id);
    const statusEl = el('status'), authStatusEl = el('auth-status');

    function showStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','ok','err');
      statusEl.classList.add(ok ? 'ok' : 'err');
      setTimeout(() => statusEl.classList.add('hidden'), ok ? 2500 : 6000);
    }

    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // Family members + colors (client-only; DB stores just 'who')
    const PEOPLE = ["JoJo","Lovi","MaiMai","Carol","Jase","LB"];
    const COLORS = {
      JoJo:"#34a853", Lovi:"#4285f4", MaiMai:"#fbbc05",
      Carol:"#ea4335", Jase:"#9c27b0", LB:"#00acc1"
    };

    // Populate the "Who" select with colored dots
    const whoSelect = el('event-who');
    function renderWhoOptions() {
      whoSelect.innerHTML = '<option value="">â€” select â€”</option>' +
        PEOPLE.map(name => `<option value="${name}" class="who-option" data-color="${COLORS[name]}">${name}</option>`).join('');
      // Apply inline dot colors (for iOS/Android consistency)
      Array.from(whoSelect.options).forEach(opt => {
        if (opt.dataset.color) opt.style.backgroundImage =
          `radial-gradient(circle at 12px 50%, ${opt.dataset.color} 0 6px, transparent 7px)`;
      });
    }
    renderWhoOptions();

    // Toggle time fields when all-day changes
    const allDayCb = el('event-all-day');
    const timeStartWrap = el('time-start-wrap');
    const timeEndWrap = el('time-end-wrap');
    allDayCb.addEventListener('change', () => {
      const showTimes = !allDayCb.checked;
      timeStartWrap.classList.toggle('hidden', !showTimes);
      timeEndWrap.classList.toggle('hidden', !showTimes);
    });

    // Helpers
    const pad2 = (n) => String(n).padStart(2,'0');
    const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const hm  = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    function addDays(ymdStr, days) {
      const d = new Date(ymdStr + "T00:00:00");
      d.setDate(d.getDate() + days);
      return ymd(d);
    }

    // Calendar
    let calendar;
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await getRedirectResult(auth);
        if (res?.user) { authStatusEl.textContent = "Welcome, " + (res.user.email || ""); showStatus("Logged in with Google.", true); }
      } catch(e) { if (e?.message) showStatus(e.message, false); }

      calendar = new FullCalendar.Calendar(el("calendar"), {
        initialView: "dayGridMonth",

        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },

        // Make day names and numbers clickable to switch views
        navLinks: true,              // <â€” NEW: click day/week names to navigate
        navLinkDayClick: (date) => { // also handle click on title nav links
          calendar.changeView("timeGridDay", date);
        },

        slotMinTime: "06:00:00",
        slotMaxTime: "22:00:00",
        nowIndicator: true,
        expandRows: true,
        dayMaxEvents: true,

        // Drag & resize
        editable: true,
        eventStartEditable: true,
        eventDurationEditable: true,

        // Range select to prefill form
        selectable: true,
        selectMirror: true,

        // Color events by 'who'
        eventDidMount: (info) => {
          const who = info.event.extendedProps.who;
          const color = COLORS[who] || "#4b5563";
          info.el.style.backgroundColor = color;
          info.el.style.borderColor = color;
          info.el.style.color = "#fff";
        },

        // Force Month/Week â†’ Day (hourly) on date clicks; in Day, open form for that time
        dateClick: (info) => {
          const current = calendar.view.type;
          if (current === "timeGridDay") {
            if (!auth.currentUser) { showStatus("Please log in to add events.", false); return; }
            const d = info.date;
            el("event-id").value = "";
            el("event-title").value = "";
            whoSelect.value = "";
            el("event-date-start").value = ymd(d);
            el("event-date-end").value   = ymd(d);
            el("event-time-start").value = `${pad2(d.getHours())}:00`;
            el("event-time-end").value   = `${pad2((d.getHours()+1)%24)}:00`;
            allDayCb.checked = false;
            timeStartWrap.classList.remove('hidden');
            timeEndWrap.classList.remove('hidden');
            el("event-form").classList.remove("hidden");
          } else {
            calendar.changeView("timeGridDay", info.date); // <â€” ensure it *switches* to hourly
          }
        },

        select: (selectionInfo) => {
          if (!auth.currentUser) { showStatus("Please log in to add events.", false); return; }
          const start = selectionInfo.start;
          const end   = selectionInfo.end;
          const isTimed = selectionInfo.view.type !== "dayGridMonth";

          el("event-id").value = "";
          el("event-title").value = "";
          whoSelect.value = "";
          el("event-date-start").value = ymd(start);
          el("event-date-end").value   = ymd(end);

          if (isTimed) {
            allDayCb.checked = false;
            timeStartWrap.classList.remove('hidden');
            timeEndWrap.classList.remove('hidden');
            el("event-time-start").value = hm(start);
            el("event-time-end").value   = hm(end);
          } else {
            allDayCb.checked = true;
            timeStartWrap.classList.add('hidden');
            timeEndWrap.classList.add('hidden');
            el("event-date-end").value = ymd(start);
          }

          el("event-form").classList.remove("hidden");
        },

        // Inline edit: clicking an event opens the form prefilled
        eventClick: (info) => {
          const e = info.event;
          if (!auth.currentUser) { showStatus("Please log in to edit.", false); return; }

          el("event-id").value = e.id;
          el("event-title").value = e.title || "";
          whoSelect.value = e.extendedProps.who || "";

          if (e.allDay) {
            allDayCb.checked = true;
            timeStartWrap.classList.add('hidden');
            timeEndWrap.classList.add('hidden');
            el("event-date-start").value = ymd(e.start);
            el("event-date-end").value = e.end ? ymd(new Date(e.end)) : ymd(e.start);
          } else {
            allDayCb.checked = false;
            timeStartWrap.classList.remove('hidden');
            timeEndWrap.classList.remove('hidden');
            el("event-date-start").value = ymd(e.start);
            el("event-date-end").value   = ymd(e.end || e.start);
            el("event-time-start").value = hm(e.start);
            el("event-time-end").value   = hm(e.end || e.start);
          }

          el("btn-delete").classList.remove("hidden");
          el("event-form").classList.remove("hidden");
        },

        // Persist drag/move or resize
        eventDrop: async (info) => {
          if (!auth.currentUser) { info.revert(); showStatus("Please log in to edit.", false); return; }
          try { await saveEventFromCalendar(info.event); showStatus("Updated.", true); }
          catch (e) { console.error(e); info.revert(); showStatus("Update failed.", false); }
        },
        eventResize: async (info) => {
          if (!auth.currentUser) { info.revert(); showStatus("Please log in to edit.", false); return; }
          try { await saveEventFromCalendar(info.event); showStatus("Updated.", true); }
          catch (e) { console.error(e); info.revert(); showStatus("Update failed.", false); }
        }
      });

      calendar.render();
    });

    // ----- Auth -----
    el("btn-signup").onclick = () => {
      const email = el("auth-email").value.trim();
      const password = el("auth-password").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((u) => { el("auth-status").textContent = "Signed up as " + (u.user.email || ""); showStatus("Signed up.", true); })
        .catch((e) => { el("auth-status").textContent = e.message; showStatus(e.message, false); });
    };

    el("btn-login").onclick = () => {
      const email = el("auth-email").value.trim();
      const password = el("auth-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then((u) => { el("auth-status").textContent = "Welcome, " + (u.user.email || ""); showStatus("Logged in.", true); })
        .catch((e) => { el("auth-status").textContent = e.message; showStatus(e.message, false); });
    };

    el("btn-google").onclick = async () => {
      try {
        if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else { await signInWithPopup(auth, googleProvider); showStatus("Logged in with Google.", true); }
      } catch (e) {
        if (e?.code === 'auth/popup-blocked') {
          try { await signInWithRedirect(auth, googleProvider); } catch (err) { showStatus(err.message, false); }
        } else showStatus(e.message, false);
      }
    };

    function doLogout() {
      signOut(auth).then(() => {
        el("auth-status").textContent = "Logged out.";
        showStatus("Logged out.", true);
        calendar.removeAllEvents();
        el("event-form").classList.add("hidden");
        el("toolbar").classList.add("hidden");
        el("auth-section").classList.remove("hidden");
      });
    }
    el("btn-logout").onclick = doLogout;
    el("btn-logout-toolbar").onclick = doLogout;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        el("auth-status").textContent = "Welcome, " + (user.email || "");
        el("auth-section").classList.add("hidden");
        el("event-form").classList.remove("hidden");
        el("toolbar").classList.remove("hidden");
        loadEvents(true);
      } else {
        el("auth-status").textContent = "";
        el("auth-section").classList.remove("hidden");
        el("event-form").classList.add("hidden");
        el("toolbar").classList.add("hidden");
        calendar && calendar.removeAllEvents();
      }
    });

    // ----- Toolbar buttons -----
    el("btn-refresh").onclick = () => loadEvents(false);
    el("btn-back-month").onclick = () => calendar.changeView("dayGridMonth");

    // ----- Save / Load / Delete -----
    function buildDbRecordFromCalEvent(fcEvent) {
      const id = fcEvent.id;
      const isAllDay = fcEvent.allDay;
      const who = fcEvent.extendedProps.who || "";

      if (isAllDay) {
        const startDate = ymd(fcEvent.start);
        const endDateExclusive = fcEvent.end ? ymd(fcEvent.end) : null;
        const rec = { id, title: fcEvent.title || "", start: startDate, allDay: true, who };
        if (endDateExclusive) rec.end = endDateExclusive;
        return rec;
      } else {
        const start = fcEvent.start;
        const end   = fcEvent.end || new Date(start.getTime());
        const rec = {
          id,
          title: fcEvent.title || "",
          start: ymd(start),
          end: ymd(end),
          allDay: false,
          timeStart: hm(start),
          timeEnd: hm(end),
          who
        };
        return rec;
      }
    }

    async function saveEventFromCalendar(fcEvent) {
      // preserve 'who' from extendedProps
      const rec = buildDbRecordFromCalEvent(fcEvent);
      await set(ref(db, "events/" + rec.id), rec);
    }

    function toCalendarEventFromDb(obj) {
      // Build a FullCalendar event from DB record; attach extendedProps.who
      const who = obj.who || "";
      if (!obj.allDay && obj.timeStart) {
        const endDate = obj.end || obj.start;
        const tEnd = obj.timeEnd || obj.timeStart;
        return {
          id: obj.id, title: obj.title, allDay: false, extendedProps: { who },
          start: `${obj.start}T${obj.timeStart}`, end: `${endDate}T${tEnd}`
        };
      } else {
        return {
          id: obj.id, title: obj.title, allDay: true, extendedProps: { who },
          start: obj.start, end: obj.end || null
        };
      }
    }

    function isValidEventForCalendar(e) {
      if (!e || typeof e.title !== 'string' || !e.title.trim()) return false;
      if (e.allDay) return typeof e.start === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(e.start);
      return typeof e.start === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(e.start);
    }

    async function loadEvents(isInitial) {
      if (!auth.currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const raw = Object.values(data);

        const events = [];
        let ok=0, bad=0;
        for (const obj of raw) {
          const ev = toCalendarEventFromDb(obj);
          if (isValidEventForCalendar(ev)) { events.push(ev); ok++; }
          else { bad++; }
        }

        calendar.removeAllEvents();
        calendar.addEventSource(events);
        showStatus(`Loaded ${ok} event(s)` + (bad ? `, skipped ${bad}` : ''), true);

        if (isInitial && ok===0 && raw.length>0) {
          showStatus("Found events, but none valid to display. Check fields.", false);
        }
      } catch (e) {
        console.error(e);
        showStatus(e.message || "Failed to load events.", false);
      }
    }

    // Form â†’ Save/Delete
    function gatherFormToDbRecord() {
      const id = el("event-id").value || Date.now().toString();
      const title = el("event-title").value.trim();
      const who = whoSelect.value || "";
      const startDate = el("event-date-start").value;
      const endDateInc = el("event-date-end").value;
      const allDay = el("event-all-day").checked;
      const tStart = el("event-time-start").value;
      const tEnd = el("event-time-end").value;

      if (!title || !startDate) { showStatus("Title and start date are required.", false); return null; }

      const rec = { id, title, start: startDate, allDay: !!allDay, who };
      if (allDay) {
        if (endDateInc && endDateInc >= startDate) rec.end = addDays(endDateInc, 1); // exclusive
      } else {
        const endDate = endDateInc || startDate;
        rec.end = endDate;
        rec.timeStart = tStart || "00:00";
        if (tEnd) rec.timeEnd = tEnd;
      }
      return rec;
    }

    function dbRecordToCalendarEvent(rec) {
      return toCalendarEventFromDb(rec);
    }

    async function saveFromForm() {
      if (!auth.currentUser) { showStatus("Please log in to save.", false); return; }
      const rec = gatherFormToDbRecord();
      if (!rec) return;
      await set(ref(db, "events/" + rec.id), rec);
      el("event-form").classList.add("hidden");
      showStatus("Saved!", true);
      await loadEvents(false);
    }

    async function deleteFromForm() {
      if (!auth.currentUser) { showStatus("Please log in to delete.", false); return; }
      const id = el("event-id").value;
      if (!id) { el("event-form").classList.add("hidden"); return; }
      await remove(ref(db, "events/" + id));
      el("event-form").classList.add("hidden");
      showStatus("Deleted.", true);
      await loadEvents(false);
    }

    el("btn-save").onclick = saveFromForm;
    el("btn-cancel").onclick = () => el("event-form").classList.add("hidden");
    el("btn-delete").onclick = deleteFromForm;

  </script>
</body>
</html>