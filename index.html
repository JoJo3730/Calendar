<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üë™ Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA bits (optional) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding: 16px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    #calendar { max-width: 900px; margin: 16px auto; }
    .fc-event { cursor: pointer; }
    .toolbar { display:flex; gap:8px; justify-content:center; margin:10px 0 14px; }
    .toolbar button { padding:10px 14px; border-radius:12px; border:1px solid #e0e0e0; background:#fff; font-size:16px; }
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }
    .hidden { display:none !important; }

    /* Auth bar */
    #auth-bar { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    #auth-bar input { padding:10px; font-size:16px; }
    #auth-bar button { padding:10px 14px; border-radius:12px; border:1px solid #e0e0e0; background:#fff; }

    /* Form */
    #event-form { background:#f7f7f7; padding:12px; border-radius:12px; max-width:900px; margin:0 auto 10px; }
    #event-form label { display:block; margin:10px 0 4px; font-weight:600; }
    #event-form input[type="text"],
    #event-form input[type="date"],
    #event-form input[type="time"] { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1 1 260px; min-width:240px; }
    .btn-row { display:flex; gap:10px; margin-top:10px; }
    .btn-row button { flex:1; padding:12px; border-radius:12px; border:1px solid #d9d9d9; background:#fff; font-size:16px; }
    .switch { display:flex; align-items:center; gap:10px; margin-top:6px; }
    .dow { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .chip { border:1px solid #d6d6d6; padding:6px 10px; border-radius:20px; user-select:none; }
    .chip input { margin-right:6px; }
    .muted { color:#6b6b6b; font-size:13px; }
  </style>
</head>
<body>
  <h1>üë™ Family Calendar</h1>

  <!-- Auth bar -->
  <div id="auth-bar">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <button id="btn-signup">Sign Up</button>
    <button id="btn-login">Log In</button>
    <button id="btn-google">Sign in with Google</button>
    <button id="btn-logout">Log Out</button>
    <span id="auth-status" class="muted"></span>
  </div>

  <div id="status" class="hidden"></div>

  <!-- Add/Edit form -->
  <div id="event-form" class="hidden">
    <input type="hidden" id="event-id">
    <label>Title</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <div class="row">
      <div>
        <label>Start Date</label>
        <input type="date" id="event-date-start">
      </div>
      <div>
        <label>End Date (optional, inclusive)</label>
        <input type="date" id="event-date-end">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Start Time (optional)</label>
        <input type="time" id="event-time-start" step="60">
      </div>
      <div>
        <label>End Time (optional)</label>
        <input type="time" id="event-time-end" step="60">
      </div>
    </div>

    <div class="switch">
      <input type="checkbox" id="repeat-weekly">
      <label for="repeat-weekly">Repeat weekly</label>
    </div>

    <div id="repeat-block" class="hidden">
      <div class="dow" id="dow-list">
        <!-- day chips created by JS -->
      </div>
      <div class="row">
        <div>
          <label>Repeat until (optional, inclusive)</label>
          <input type="date" id="repeat-until">
        </div>
      </div>
      <div class="muted">Recurring events ignore the single ‚ÄúEnd Date‚Äù above. Use ‚ÄúRepeat until‚Äù instead. For timed recurring events, set start/end time.</div>
    </div>

    <div class="btn-row">
      <button id="btn-save">Save</button>
      <button id="btn-cancel">Cancel</button>
    </div>
  </div>

  <!-- View toolbar -->
  <div class="toolbar" id="view-toolbar">
    <button id="btn-refresh">Refresh</button>
    <button id="btn-month">Month</button>
    <button id="btn-week">Week</button>
    <button id="btn-day">Day</button>
  </div>

  <div id="calendar"></div>

  <script type="module">
    /******** Firebase ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    /******** Helpers ********/
    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    const authStatusEl = $('auth-status');

    function toast(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.className = ok ? 'ok' : 'err';
      statusEl.classList.remove('hidden');
      setTimeout(() => statusEl.classList.add('hidden'), ok ? 2200 : 4800);
    }

    function addDays(ymd, n) {
      const d = new Date(ymd + 'T00:00:00');
      d.setDate(d.getDate() + n);
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function timeOrNull(input) { return input && input.trim() ? input.trim() : null; }

    function showFormForDate(ymd) {
      $('event-id').value = '';
      $('event-title').value = '';
      $('event-date-start').value = ymd;
      $('event-date-end').value = ymd;
      $('event-time-start').value = '';
      $('event-time-end').value = '';
      $('repeat-weekly').checked = false;
      $('repeat-until').value = '';
      toggleRepeatBlock();
      $('event-form').classList.remove('hidden');
    }

    function toggleRepeatBlock() {
      $('repeat-block').classList.toggle('hidden', !$('repeat-weekly').checked);
    }

    /******** FullCalendar ********/
    let calendar;

    document.addEventListener('DOMContentLoaded', async () => {
      // Handle Google redirect signin results
      try {
        const res = await getRedirectResult(auth);
        if (res?.user) {
          authStatusEl.textContent = "Welcome, " + (res.user.email || "");
          toast("Logged in with Google.", true);
        }
      } catch (e) {
        if (e?.message) toast(e.message, false);
      }

      // Create DOW chips
      const labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const dowList = $('dow-list');
      labels.forEach((lbl, idx) => {
        const div = document.createElement('label');
        div.className = 'chip';
        div.innerHTML = `<input type="checkbox" value="${idx}">${lbl}`;
        dowList.appendChild(div);
      });

      $('repeat-weekly').addEventListener('change', toggleRepeatBlock);

      calendar = new FullCalendar.Calendar($('calendar'), {
        initialView: 'dayGridMonth',
        fixedWeekCount: true,   // always 6 weeks
        headerToolbar: false,
        dayMaxEventRows: true,
        firstDay: 0,            // Sunday
        buttonText: { today: 'today' },
        datesSet: () => {},

        // Click empty day ‚Üí open form (prefilled)
        dateClick: (info) => {
          if (!auth.currentUser) { toast('Please log in to add events.', false); return; }
          showFormForDate(info.dateStr);
        },

        // Click existing event ‚Üí open Edit/Delete prompt
        eventClick: (info) => {
          if (!auth.currentUser) { toast('Please log in to edit.', false); return; }
          const ev = info.event;

          // Load form with event props
          $('event-id').value = ev.id || '';
          $('event-title').value = ev.title || '';

          // If recurring (daysOfWeek exists) use startRecur/endRecur + times
          const dow = ev.extendedProps.daysOfWeek || ev._def.recurringDef?.typeData?.daysOfWeek;
          const isRecurring = Array.isArray(dow) && dow.length;

          if (isRecurring) {
            $('repeat-weekly').checked = true;
            toggleRepeatBlock();

            // check chips
            Array.from($('dow-list').querySelectorAll('input[type=checkbox]')).forEach(cb => {
              cb.checked = dow.includes(parseInt(cb.value));
            });

            const startRecur = ev.extendedProps.startRecur || ev._def.recurringDef?.typeData?.startRecur;
            const endRecurEx = ev.extendedProps.endRecur || ev._def.recurringDef?.typeData?.endRecur;

            $('event-date-start').value = startRecur ? startRecur : '';
            $('event-date-end').value = ''; // unused for recurring
            $('repeat-until').value = endRecurEx ? addDays(endRecurEx, -1) : '';

            const st = ev.extendedProps.startTime || ev._def.recurringDef?.typeData?.startTime;
            const et = ev.extendedProps.endTime || ev._def.recurringDef?.typeData?.endTime;
            $('event-time-start').value = st || '';
            $('event-time-end').value = et || '';
          } else {
            $('repeat-weekly').checked = false;
            toggleRepeatBlock();

            const startISO = ev.startStr?.slice(0,10) || '';
            const endISOex = ev.endStr?.slice(0,10) || '';
            $('event-date-start').value = startISO;
            $('event-date-end').value = endISOex ? addDays(endISOex, -1) : startISO;

            const st = ev.extendedProps.startTime;
            const et = ev.extendedProps.endTime;
            $('event-time-start').value = st || '';
            $('event-time-end').value = et || '';
          }

          $('event-form').classList.remove('hidden');

          // Offer delete from calendar UI (confirmation inside Save/Delete handlers)
          info.jsEvent.preventDefault();
        }
      });

      calendar.render();

      // Toolbar view switches
      $('btn-month').onclick = () => calendar.changeView('dayGridMonth');
      $('btn-week').onclick  = () => calendar.changeView('timeGridWeek');
      $('btn-day').onclick   = () => calendar.changeView('timeGridDay');
      $('btn-refresh').onclick = () => loadEvents();

      // Auth buttons
      $('btn-signup').onclick = () => {
        const email = $('auth-email').value.trim();
        const password = $('auth-password').value;
        createUserWithEmailAndPassword(auth, email, password)
          .then(u => { authStatusEl.textContent = "Signed up as " + (u.user.email || ""); toast("Signed up.", true); })
          .catch(e => { authStatusEl.textContent = e.message; toast(e.message, false); });
      };

      $('btn-login').onclick = () => {
        const email = $('auth-email').value.trim();
        const password = $('auth-password').value;
        signInWithEmailAndPassword(auth, email, password)
          .then(u => { authStatusEl.textContent = "Welcome, " + (u.user.email || ""); toast("Logged in.", true); })
          .catch(e => { authStatusEl.textContent = e.message; toast(e.message, false); });
      };

      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      $('btn-google').onclick = async () => {
        try {
          if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
          else await signInWithPopup(auth, googleProvider);
          toast("Logged in with Google.", true);
        } catch (e) {
          if (e?.code === 'auth/popup-blocked') {
            try { await signInWithRedirect(auth, googleProvider); } catch (err) { toast(err.message, false); }
          } else toast(e.message, false);
        }
      };

      $('btn-logout').onclick = () => {
        signOut(auth).then(() => {
          authStatusEl.textContent = "Logged out.";
          toast("Logged out.", true);
          calendar.removeAllEvents();
          $('event-form').classList.add('hidden');
        });
      };

      onAuthStateChanged(auth, (user) => {
        const loggedIn = !!user;
        // Hide email/password when logged in, show logout + welcome
        $('auth-email').classList.toggle('hidden', loggedIn);
        $('auth-password').classList.toggle('hidden', loggedIn);
        $('btn-signup').classList.toggle('hidden', loggedIn);
        $('btn-login').classList.toggle('hidden', loggedIn);
        $('btn-google').classList.toggle('hidden', loggedIn);
        $('btn-logout').classList.toggle('hidden', !loggedIn);
        authStatusEl.textContent = loggedIn ? ("Welcome, " + (user.email || "")) : "";

        if (loggedIn) {
          $('event-form').classList.add('hidden');  // open only on date click or event click
          loadEvents();
        } else {
          calendar.removeAllEvents();
        }
      });

      // Form buttons
      $('btn-save').onclick = saveEvent;
      $('btn-cancel').onclick = () => $('event-form').classList.add('hidden');
    });

    /******** Save & Load ********/
    async function saveEvent() {
      if (!auth.currentUser) { toast("Please log in to save.", false); return; }

      const id = $('event-id').value || Date.now().toString();
      const title = $('event-title').value.trim();
      const startDate = $('event-date-start').value;
      const endDateInc = $('event-date-end').value;
      const tStart = timeOrNull($('event-time-start').value);
      const tEnd = timeOrNull($('event-time-end').value);
      const repeat = $('repeat-weekly').checked;
      const repeatUntilInc = $('repeat-until').value;

      if (!title || !startDate) { toast("Title and start date are required.", false); return; }

      let event = { id, title };

      if (repeat) {
        // Weekly recurrence
        const days = Array.from($('dow-list').querySelectorAll('input[type=checkbox]'))
                          .filter(cb => cb.checked)
                          .map(cb => parseInt(cb.value));
        if (!days.length) { toast("Pick at least one weekday for the weekly repeat.", false); return; }

        event.daysOfWeek = days;  // [0..6]
        event.allDay = !tStart && !tEnd;
        if (tStart) event.startTime = tStart;
        if (tEnd)   event.endTime   = tEnd;

        event.startRecur = startDate;
        if (repeatUntilInc) {
          // endRecur is EXCLUSIVE in FC
          event.endRecur = addDays(repeatUntilInc, 1);
        }
      } else {
        // Single/explicit event
        const allDay = !tStart && !tEnd;
        event.allDay = allDay;
        event.start = startDate + (tStart ? `T${tStart}` : '');
        if (endDateInc) {
          if (allDay) {
            event.end = addDays(endDateInc, 1); // exclusive
          } else if (tEnd) {
            event.end = endDateInc + `T${tEnd}`;
          }
        }
        if (tStart) event.startTime = tStart;
        if (tEnd)   event.endTime   = tEnd;
      }

      try {
        await set(ref(db, "events/" + id), event);
        $('event-form').classList.add('hidden');
        toast("Saved!", true);
        await loadEvents();
      } catch (e) {
        toast(e.message, false);
      }
    }

    async function loadEvents() {
      if (!auth.currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const list = Object.values(data);

        // Normalize legacy shapes
        const evs = list.map(e => {
          const n = { ...e };
          // Legacy all-day end was inclusive; if 'end' exists and allDay true,
          // assume already exclusive in DB from our code; otherwise keep as-is.
          return n;
        });

        calendar.removeAllEvents();
        calendar.addEventSource(evs);
        toast(`Loaded ${evs.length} event(s).`, true);
      } catch (e) {
        console.error(e);
        toast(e.message || "Failed to load events.", false);
      }
    }
  </script>
</body>
</html>