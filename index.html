<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA meta (kept) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root{ --ok:#0a7a0a; --err:#b00020; --muted:#666; }
    *{ box-sizing:border-box; }
    body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin:0; padding:18px; }
    h2{ margin:0 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    button{ padding:10px 12px; font-size:16px; }
    input, select{ padding:10px; font-size:16px; width:100%; }
    .card{ background:#f6f6f6; border-radius:10px; padding:14px; }

    /* Auth */
    #auth-wrap input{ margin:6px 0; }
    #auth-buttons button{ flex:1; min-width:140px; }
    .hidden{ display:none !important; }

    /* Welcome bar */
    #welcome-bar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #welcome-email{ font-weight:600; }

    /* Form */
    #form h3{ margin:0 0 8px; }
    label{ display:block; margin:10px 0 6px; color:#333; }
    #status{ margin:8px 0; font-size:14px; }
    #status.ok{ color:var(--ok); }
    #status.err{ color:var(--err); }

    /* Toolbar */
    #toolbar{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin:10px 0; }
    #toolbar .spacer{ flex:1; }
    #toolbar .view-btn{ min-width:90px; }

    /* Calendar */
    #calendar{ max-width:1000px; margin:0 auto; }

    /* Footer */
    #meta{ margin-top:14px; color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
    #meta code{ background:#f1f1f1; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h2>ðŸ‘ª Family Calendar</h2>

  <!-- AUTH: shown when logged out -->
  <section id="auth-wrap" class="card">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <div id="auth-buttons" class="row">
      <button id="btn-signup">Sign Up</button>
      <button id="btn-login">Log In</button>
      <button id="btn-google">Sign in with Google</button>
      <button id="btn-logout" class="hidden">Log Out</button>
    </div>
    <p id="auth-status"></p>
  </section>

  <!-- WELCOME BAR: shown when logged in -->
  <section id="welcome-bar" class="card hidden">
    <div id="welcome-email">Welcome</div>
    <button id="btn-logout-top">Log Out</button>
  </section>

  <div id="status" class="hidden"></div>

  <!-- EVENT FORM -->
  <section id="form" class="card hidden" style="max-width:1000px; margin:12px auto;">
    <h3>Add / Edit Event</h3>
    <input type="hidden" id="event-id">

    <label for="event-title">Title:</label>
    <input id="event-title" type="text" placeholder="e.g., Vacation">

    <div class="row">
      <div style="flex:1;">
        <label for="date-start">Start Date:</label>
        <input id="date-start" type="date">
      </div>
      <div style="flex:1;">
        <label for="date-end">End Date (optional, inclusive):</label>
        <input id="date-end" type="date">
      </div>
    </div>

    <div class="row">
      <div style="flex:1;">
        <label for="time-start">Start Time (optional):</label>
        <input id="time-start" type="time">
      </div>
      <div style="flex:1;">
        <label for="time-end">End Time (optional):</label>
        <input id="time-end" type="time">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="btn-save">Save</button>
      <button id="btn-cancel" type="button">Cancel</button>
    </div>
  </section>

  <!-- TOOLBAR (Option A + view toggles) -->
  <section id="toolbar" class="hidden" style="max-width:1000px; margin:10px auto;">
    <div class="spacer"></div>
    <button id="btn-prev">â€¹</button>
    <button id="btn-today">today</button>
    <button id="btn-next">â€º</button>
    <button id="btn-refresh">Refresh</button>
    <button id="btn-month" class="view-btn">Month</button>
    <button id="btn-day" class="view-btn">Day</button>
  </section>

  <div id="calendar"></div>

  <div id="meta">
    <span>Version: <code>v1.1.0</code></span>
    <span>Deployed: <code>2025-08-08 18:45</code></span>
  </div>

  <!-- Firebase (modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    // --- Firebase init ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // --- Helpers ---
    const el = id => document.getElementById(id);
    const statusEl = el('status');
    const authWrap = el('auth-wrap');
    const authStatusEl = el('auth-status');
    const welcomeBar = el('welcome-bar');
    const welcomeEmail = el('welcome-email');

    function showStatus(msg, ok=false){
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','ok','err');
      statusEl.classList.add(ok ? 'ok' : 'err');
      // auto-hide
      setTimeout(()=>statusEl.classList.add('hidden'), ok? 2500 : 6000);
    }

    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // --- FullCalendar init ---
    let calendar;
    document.addEventListener("DOMContentLoaded", async () => {
      // handle Google redirect result (iOS/Safari)
      try{
        const res = await getRedirectResult(auth);
        if(res?.user){ showStatus("Logged in with Google.", true); }
      }catch(e){ /* ignore */ }

      calendar = new FullCalendar.Calendar(el("calendar"), {
        initialView: "dayGridMonth",
        headerToolbar: false,
        height: "auto",
        dateClick(info){
          if(!auth.currentUser){ showStatus("Please log in to add events.", false); return; }
          openFormForDate(info.dateStr);
        },
        eventClick(info){
          if(!auth.currentUser){ showStatus("Please log in to modify.", false); return; }
          const e = info.event;
          if(confirm(`Delete "${e.title}"?`)){
            remove(ref(db, "events/" + e.id))
              .then(()=>{ info.event.remove(); showStatus("Deleted.", true); })
              .catch(err=>showStatus(err.message, false));
          }
        }
      });
      calendar.render();
    });

    // --- Form opening ---
    function openFormForDate(ymd){
      el('form').classList.remove('hidden');
      el('event-id').value = "";
      el('event-title').value = "";
      el('date-start').value = ymd;
      el('date-end').value = ymd;
      el('time-start').value = "";
      el('time-end').value   = "";
      // If user clicked a day cell while in Month, also show Day view for quick context
      if(calendar.view.type !== 'timeGridDay'){
        calendar.changeView('timeGridDay', ymd);
      }
    }

    // --- Auth UI wiring ---
    function showLoggedInUI(email){
      authWrap.classList.add('hidden');            // hide email/password area
      el('btn-logout').classList.add('hidden');    // keep logout only in welcome bar
      welcomeEmail.textContent = `Welcome, ${email}`;
      welcomeBar.classList.remove('hidden');
      el('toolbar').classList.remove('hidden');
      el('form').classList.remove('hidden');
    }
    function showLoggedOutUI(){
      welcomeBar.classList.add('hidden');
      authWrap.classList.remove('hidden');
      el('toolbar').classList.add('hidden');
      el('form').classList.add('hidden');
      calendar && calendar.removeAllEvents();
    }

    // Signup / login / Google / logout
    el("btn-signup").onclick = () => {
      const email = el("auth-email").value.trim();
      const pw = el("auth-password").value;
      createUserWithEmailAndPassword(auth, email, pw)
        .then(u => { showStatus("Signed up.", true); })
        .catch(e => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };
    el("btn-login").onclick = () => {
      const email = el("auth-email").value.trim();
      const pw = el("auth-password").value;
      signInWithEmailAndPassword(auth, email, pw)
        .then(() => showStatus("Logged in.", true))
        .catch(e => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };
    el("btn-google").onclick = async () => {
      try{
        if(isIOS || isSafari){ await signInWithRedirect(auth, googleProvider); }
        else { await signInWithPopup(auth, googleProvider); showStatus("Logged in with Google.", true); }
      }catch(e){
        if(e?.code === 'auth/popup-blocked'){
          try{ await signInWithRedirect(auth, googleProvider); }catch(err){ showStatus(err.message, false); }
        }else showStatus(e.message, false);
      }
    };
    function doLogout(){
      signOut(auth).then(()=>{
        showStatus("Logged out.", true);
        showLoggedOutUI();
      });
    }
    el("btn-logout").onclick = doLogout;
    el("btn-logout-top").onclick = doLogout;

    // React to auth state
    onAuthStateChanged(auth, user => {
      if(user){
        showLoggedInUI(user.email || "");
        loadEvents(true);
      }else{
        showLoggedOutUI();
      }
    });

    // --- Save / Cancel / Refresh ---
    el("btn-save").onclick = saveEvent;
    el("btn-cancel").onclick = () => el("form").classList.add("hidden");
    el("btn-refresh").onclick = () => loadEvents(false);

    // --- Nav buttons (Option A) ---
    el("btn-prev").onclick  = () => calendar.prev();
    el("btn-next").onclick  = () => calendar.next();
    el("btn-today").onclick = () => calendar.today();

    // View toggles
    el("btn-month").onclick = () => calendar.changeView('dayGridMonth');
    el("btn-day").onclick   = () => {
      const d = calendar.getDate();
      const ymd = d.toISOString().slice(0,10);
      calendar.changeView('timeGridDay', ymd);
    };

    // --- Event helpers ---
    function addDays(ymd, days){
      const d = new Date(ymd + "T00:00:00");
      d.setDate(d.getDate() + days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function toISO(ymd, hm){ // "YYYY-MM-DD","HH:MM" -> ISO
      if(!hm) return ymd; // we'll treat as all-day date
      return `${ymd}T${hm}:00`;
    }

    function saveEvent(){
      if(!auth.currentUser){ showStatus("Please log in to save.", false); return; }

      const id    = el("event-id").value || Date.now().toString();
      const title = el("event-title").value.trim();
      const ds    = el("date-start").value;
      const de    = el("date-end").value;
      const ts    = el("time-start").value;
      const te    = el("time-end").value;

      if(!title || !ds){ showStatus("Title and start date are required.", false); return; }

      let ev;
      if(ts || te){
        // Timed event (use ISO start/end; no allDay)
        const startISO = toISO(ds, ts || "00:00");
        let endISO;
        if(te){
          endISO = toISO(de || ds, te);
        }else{
          // if no end time, default to +1 hour
          const dt = new Date(startISO);
          dt.setHours(dt.getHours()+1);
          endISO = dt.toISOString().slice(0,19);
        }
        ev = { id, title, start: startISO, end: endISO, allDay:false };
      }else{
        // All-day event (end is exclusive)
        const endExclusive = (de && de >= ds) ? addDays(de,1) : addDays(ds,1);
        ev = { id, title, start: ds, end: endExclusive, allDay:true };
      }

      set(ref(db,"events/"+id), ev)
        .then(()=>{ showStatus("Saved!", true); el("form").classList.add("hidden"); return loadEvents(false); })
        .catch(e => showStatus(e.message, false));
    }

    function normalizeEvent(obj){
      const e = { id: String(obj.id || Date.now()), title: obj.title };
      if(obj.allDay === false){
        e.start = obj.start; if(obj.end) e.end = obj.end; e.allDay = false;
      }else{
        e.start = obj.start || obj.date;
        if(obj.end) e.end = obj.end;
        e.allDay = true;
      }
      return e;
    }
    function isValidEvent(e){
      if(!e || typeof e.title !== 'string' || !e.title.trim()) return false;
      if(!e.start) return false;
      return true;
    }

    async function loadEvents(isInitial){
      if(!auth.currentUser) return;
      try{
        const snap = await get(ref(db,"events"));
        const data = snap.val() || {};
        const raw = Object.values(data);
        let ok=0, bad=0;
        const events=[];
        for(const obj of raw){
          const e = normalizeEvent(obj);
          if(isValidEvent(e)){ events.push(e); ok++; } else { bad++; }
        }
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        const msg = `Loaded ${ok} event(s)` + (bad?`, skipped ${bad}`:'');
        showStatus(msg, true);
      }catch(e){
        console.error(e);
        showStatus(e.message || "Failed to load events.", false);
      }
    }
  </script>
</body>
</html>