<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>

  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --muted:#667085; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin:0; padding:16px; }
    h1 { margin:0 0 8px; font-size:32px; display:flex; align-items:center; gap:10px; }
    #signedInAs { color:#444; margin:6px 0 12px; }
    .pill { padding:10px 18px; border-radius:12px; border:1px solid #d0d5dd; background:#fff; font-size:18px; }
    .pill.primary { background:#edf2ff; border-color:#c7d2fe; }
    .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .spacer { flex:1; }
    #logoutBtn { background:#ffe4e6; border-color:#fecdd3; }
    #monthTitle { font-size:42px; font-weight:800; margin:18px 0 8px; }
    .navRow { display:flex; gap:10px; align-items:center; margin:8px 0 16px; }
    .navRow .navbtn { padding:10px 18px; border-radius:12px; border:1px solid #d0d5dd; background:#fff; font-size:18px; }
    #status { margin:8px 0 12px; font-size:15px; display:none; }
    #status.ok { color:var(--ok); display:block; }
    #status.err { color:var(--err); display:block; }

    /* Auth area */
    #auth-section.hidden { display:none; }
    #auth-section input { width:100%; padding:12px; font-size:16px; margin:6px 0; box-sizing:border-box; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > button { flex:1; min-width: 140px; }

    /* Event form */
    #event-form { background:#f6f7f9; border:1px solid #e5e7eb; border-radius:12px; padding:14px; margin:10px 0 16px; }
    #event-form.hidden { display:none; }
    label { display:block; margin:8px 0 6px; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"] { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .actions { display:flex; gap:8px; margin-top:12px; }
    .actions button { flex:1; padding:12px; font-size:17px; border-radius:12px; border:1px solid #d0d5dd; background:#fff; }
    #btn-save { background:#2563eb; color:#fff; border-color:#2563eb; }
    #btn-delete { background:#fee2e2; border-color:#fecaca; color:#991b1b; display:none; }
    #btn-cancel { background:#fff; }

    /* Calendar */
    #calendar { max-width:1000px; margin:0 auto; }

    /* FullCalendar event colors use backgroundColor/borderColor coming from events */
    .fc-event { cursor:pointer; }

    /* Signed in text */
    #signedInAs .email { font-weight:600; }
  </style>
</head>
<body>

  <h1>ðŸ‘ª Family Calendar</h1>
  <div id="signedInAs"></div>

  <!-- Top toolbar -->
  <div class="toolbar">
    <button id="btn-refresh" class="pill">Refresh</button>
    <button id="btn-month"   class="pill">Month</button>
    <button id="btn-week"    class="pill">Week</button>
    <button id="btn-day"     class="pill">Day</button>
    <div class="spacer"></div>
    <button id="logoutBtn" class="pill" title="Sign out">Log&nbsp;Out</button>
  </div>

  <!-- Month title + nav -->
  <div id="monthTitle"></div>
  <div class="navRow">
    <button id="btn-prev" class="navbtn">â€¹</button>
    <button id="btn-today" class="navbtn">today</button>
    <button id="btn-next" class="navbtn">â€º</button>
  </div>

  <!-- Auth (hidden when logged in) -->
  <div id="auth-section" class="hidden">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="btn-signup" class="pill">Sign Up</button>
      <button id="btn-login"  class="pill">Log In</button>
    </div>
  </div>

  <div id="status"></div>

  <!-- Event form -->
  <div id="event-form" class="hidden">
    <input type="hidden" id="event-id">
    <label>Title</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <label>Start Date</label>
    <input type="date" id="event-date-start">

    <label>End Date (optional, inclusive)</label>
    <input type="date" id="event-date-end">

    <label>Start Time (optional)</label>
    <input type="time" id="event-time-start">

    <label>End Time (optional)</label>
    <input type="time" id="event-time-end">

    <div class="actions">
      <button id="btn-save">Save</button>
      <button id="btn-delete">Delete</button>
      <button id="btn-cancel">Cancel</button>
    </div>
  </div>

  <div id="calendar"></div>

  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    /* ---------- Helpers & UI ---------- */
    const el = id => document.getElementById(id);
    const statusEl = el('status');
    const authBox  = el('auth-section');
    const signedInAs = el('signedInAs');
    const logoutBtn = el('logoutBtn');

    function flash(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.className = ok ? 'ok' : 'err';
      statusEl.style.display = 'block';
      setTimeout(()=> statusEl.style.display='none', ok?2200:4500);
    }

    // Color per user email
    const USER_COLORS = {
      "jmtrandlyt@gmail.com": "#06b6d4",      // cyan
      "josephandlori@hotmail.com":"#22c55e",  // green
      "carolinefrederick123@gmail.com":"#ef4444", // red
      "madimack95@gmail.com":"#f43f5e",       // pink
      "jasethompson860@gmail.com":"#a855f7"   // violet
    };
    function colorFor(email) {
      const key = (email || "").trim().toLowerCase();
      return USER_COLORS[key] || "#3b82f6"; // fallback blue
    }

    // combine "YYYY-MM-DD" + "HH:MM" -> ISO string in local time
    function combineYmdHm(ymd, hm) {
      if (!ymd || !hm) return null;
      const [h,m] = hm.split(':').map(n=>parseInt(n,10));
      const d = new Date(ymd + "T00:00:00");
      d.setHours(h, m, 0, 0);
      return d.toISOString();
    }
    function addDays(ymd, days) {
      const d = new Date(ymd + "T00:00:00");
      d.setDate(d.getDate()+days);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    /* ---------- FullCalendar ---------- */
    let calendar;
    let currentUser = null;

    function updateMonthTitle() {
      const date = calendar ? calendar.getDate() : new Date();
      const fmt = date.toLocaleString(undefined, { month:'long', year:'numeric' });
      el('monthTitle').textContent = fmt;
    }

    document.addEventListener('DOMContentLoaded', () => {
      calendar = new FullCalendar.Calendar(el('calendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        firstDay: 0,
        height: 'auto',

        dateClick: info => {
          if (!currentUser) { flash("Please log in to add events."); return; }
          // Prepare blank form for this date
          el('event-id').value = "";
          el('event-title').value = "";
          el('event-date-start').value = info.dateStr;
          el('event-date-end').value = info.dateStr;
          el('event-time-start').value = "";
          el('event-time-end').value = "";
          el('btn-delete').style.display = 'none';
          el('event-form').classList.remove('hidden');
        },

        eventClick: info => {
          if (!currentUser) { flash("Please log in to edit/delete."); return; }
          const e = info.event;
          // Fill form from event props
          el('event-id').value = e.id || "";
          el('event-title').value = e.title || "";

          // Dates/times
          // For all-day we store YYYY-MM-DD in start (and end exclusive)
          if (e.allDay) {
            el('event-date-start').value = e.startStr;
            const inclusive = e.end ? addDays(e.endStr, -1) : e.startStr;
            el('event-date-end').value = inclusive;
            el('event-time-start').value = "";
            el('event-time-end').value = "";
          } else {
            const s = e.start;
            const y = s.getFullYear(), m=String(s.getMonth()+1).padStart(2,'0'), d=String(s.getDate()).padStart(2,'0');
            el('event-date-start').value = `${y}-${m}-${d}`;
            const st = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
            el('event-time-start').value = st;

            if (e.end) {
              const ee = e.end;
              const yy=ee.getFullYear(), mm=String(ee.getMonth()+1).padStart(2,'0'), dd=String(ee.getDate()).padStart(2,'0');
              el('event-date-end').value = `${yy}-${mm}-${dd}`;
              const et = `${String(ee.getHours()).padStart(2,'0')}:${String(ee.getMinutes()).padStart(2,'0')}`;
              el('event-time-end').value = et;
            } else {
              el('event-date-end').value = el('event-date-start').value;
              el('event-time-end').value = "";
            }
          }

          el('btn-delete').style.display = e.id ? 'block' : 'none';
          el('event-form').classList.remove('hidden');
        },

        events: [] // we load programmatically
      });

      calendar.render();
      updateMonthTitle();
    });

    // view buttons
    el('btn-month').onclick = () => { calendar.changeView('dayGridMonth'); updateMonthTitle(); };
    el('btn-week').onclick  = () => { calendar.changeView('timeGridWeek'); updateMonthTitle(); };
    el('btn-day').onclick   = () => { calendar.changeView('timeGridDay'); updateMonthTitle(); };

    // nav
    el('btn-prev').onclick  = () => { calendar.prev();  updateMonthTitle(); };
    el('btn-next').onclick  = () => { calendar.next();  updateMonthTitle(); };
    el('btn-today').onclick = () => { calendar.today(); updateMonthTitle(); };

    // refresh
    el('btn-refresh').onclick = () => loadEvents(false);

    /* ---------- Auth ---------- */
    function setAuthUI(user) {
      currentUser = user || null;
      if (currentUser) {
        signedInAs.innerHTML = `Signed in as <span class="email">${currentUser.email}</span>`;
        authBox.classList.add('hidden');
        logoutBtn.style.display = 'inline-block';
        el('event-form').classList.add('hidden'); // start closed
        loadEvents(true);
      } else {
        signedInAs.textContent = '';
        authBox.classList.remove('hidden');
        logoutBtn.style.display = 'none';
        calendar && calendar.removeAllEvents();
      }
    }

    onAuthStateChanged(auth, setAuthUI);

    el('btn-signup').onclick = async () => {
      try {
        const email = el('auth-email').value.trim();
        const pass  = el('auth-password').value;
        await createUserWithEmailAndPassword(auth, email, pass);
        flash("Signed up.", true);
      } catch(e){ flash(e.message); }
    };
    el('btn-login').onclick = async () => {
      try{
        const email = el('auth-email').value.trim();
        const pass  = el('auth-password').value;
        await signInWithEmailAndPassword(auth, email, pass);
        flash("Logged in.", true);
      }catch(e){ flash(e.message); }
    };
    logoutBtn.onclick = async () => { try { await signOut(auth); } catch(e){} };

    /* ---------- Save / Delete / Cancel ---------- */
    el('btn-save').onclick = async () => {
      if (!currentUser) { flash("Please log in to save."); return; }

      const id = el('event-id').value || Date.now().toString();
      const title = el('event-title').value.trim();
      const ds = el('event-date-start').value;
      const de = el('event-date-end').value;
      const ts = el('event-time-start').value;
      const te = el('event-time-end').value;

      if (!title || !ds) { flash("Title and start date are required."); return; }

      // Construct event object
      // If times provided, make a timed event; otherwise all-day
      let startISO = ts ? combineYmdHm(ds, ts) : ds; // date string for all-day
      let endISO   = null;

      if (ts && te && de) {
        endISO = combineYmdHm(de, te);
      } else if (!ts && de) {
        // all-day inclusive end -> store exclusive end for FullCalendar
        endISO = addDays(de, 1);
      }

      const color = colorFor(currentUser.email);
      const event = {
        id,
        title,
        owner: currentUser.email,
        start: startISO,
        allDay: !ts,               // true if no start time
        color
      };
      if (endISO) event.end = endISO;
      if (ts) event.startTime = ts;
      if (te) event.endTime   = te;

      try{
        await set(ref(db, "events/"+id), event);
        flash("Saved!", true);
        el('event-form').classList.add('hidden');
        await loadEvents(false);
      }catch(e){ flash(e.message); }
    };

    el('btn-delete').onclick = async () => {
      const id = el('event-id').value;
      if (!id) return; // shouldn't happen; button hidden otherwise
      if (!confirm("Delete this event?")) return;

      try{
        await remove(ref(db, "events/"+id));
        flash("Event deleted.", true);
        el('event-form').classList.add('hidden');
        await loadEvents(false);
      }catch(e){ flash(e.message); }
    };

    el('btn-cancel').onclick = () => el('event-form').classList.add('hidden');

    /* ---------- Load events ---------- */
    async function loadEvents(isInitial){
      if (!currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const items = Object.values(data);

        // Normalize for FullCalendar
        const events = items.map(e => {
          const ev = {
            id: e.id,
            title: e.title,
            start: e.start,
            allDay: e.allDay === true,   // FullCalendar needs a boolean
            backgroundColor: e.color || colorFor(e.owner),
            borderColor: e.color || colorFor(e.owner),
            extendedProps: { owner: e.owner || "" }
          };
          if (e.end) ev.end = e.end;
          return ev;
        });

        calendar.removeAllEvents();
        calendar.addEventSource(events);
        updateMonthTitle();

        flash(`Loaded ${events.length} event(s).`, true);
      } catch(e){
        console.error(e);
        flash(e.message || "Failed to load events.");
      }
    }
  </script>
</body>
</html>