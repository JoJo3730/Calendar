<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding: 20px; }
    h2 { margin: 0 0 16px; }
    #calendar { max-width: 900px; margin: 16px auto; }
    .fc-event { cursor: pointer; }
    #auth-section input { width:100%; padding:10px; font-size:16px; margin:6px 0; box-sizing:border-box; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > button { flex:1; min-width: 140px; }
    #event-form { background:#f5f5f5; padding:12px; border-radius:8px; margin:16px 0; }
    #event-form.hidden { display:none; }
    label { display:block; margin-top:8px; }
    input[type="text"], input[type="date"], input[type="time"], button { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }
    .hidden { display:none; }
    #btn-google { background:#fff; border:1px solid #dadce0; }
    #toolbar { display:flex; gap:8px; justify-content:flex-end; margin-bottom:8px; }
    #version { font-size:12px; opacity:.7; display:flex; gap:10px; align-items:center; justify-content:center; margin-top:16px; }
    .inline { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:480px){ .inline{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <h2>ðŸ‘ª Family Calendar</h2>

  <div id="auth-section">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="btn-signup">Sign Up</button>
      <button id="btn-login">Log In</button>
      <button id="btn-google">Sign in with Google</button>
      <button id="btn-logout">Log Out</button>
    </div>
    <p id="auth-status"></p>
  </div>

  <div id="status" class="hidden"></div>

  <!-- Event form -->
  <div id="event-form" class="hidden">
    <h3 style="margin:0 0 8px;">Add / Edit Event</h3>
    <input type="hidden" id="event-id">
    <label>Title:</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <div class="inline">
      <div>
        <label>Start Date:</label>
        <input type="date" id="event-date-start">
      </div>
      <div>
        <label>End Date (optional, inclusive):</label>
        <input type="date" id="event-date-end">
      </div>
    </div>

    <!-- NEW: time inputs -->
    <div class="inline">
      <div>
        <label>Start Time (optional):</label>
        <input type="time" id="event-time-start" step="900" placeholder="HH:MM">
      </div>
      <div>
        <label>End Time (optional):</label>
        <input type="time" id="event-time-end" step="900" placeholder="HH:MM">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="btn-save">Save</button>
      <button id="btn-cancel">Cancel</button>
    </div>
  </div>

  <div id="toolbar" class="hidden">
    <button id="btn-refresh">Refresh</button>
    <button id="btn-month">Month</button>
    <button id="btn-day">Day</button>
  </div>

  <div id="calendar"></div>

  <div id="version">
    <span>Version: <code>v1.1.0</code></span> Â·
    <span>Deployed: <code>2025-08-08 18:45</code></span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    const el = (id) => document.getElementById(id);
    const statusEl = el('status');
    const authStatusEl = el('auth-status');

    function showStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','ok','err');
      statusEl.classList.add(ok ? 'ok' : 'err');
      setTimeout(() => statusEl.classList.add('hidden'), ok ? 2500 : 6000);
    }

    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    let calendar;
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await getRedirectResult(auth);
        if (res?.user) { authStatusEl.textContent = "Welcome, " + (res.user.email || ""); showStatus("Logged in with Google.", true); }
      } catch(e) { if (e?.message) showStatus(e.message, false); }

      calendar = new FullCalendar.Calendar(el("calendar"), {
        initialView: "dayGridMonth",
        headerToolbar: false,
        selectable: true,               // NEW: allow drag/select
        selectMirror: true,
        slotMinTime: "00:00:00",
        slotMaxTime: "24:00:00",
        slotDuration: "00:30:00",
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },

        dateClick: (info) => {
          if (!auth.currentUser) { showStatus("Please log in to add events.", false); return; }
          // If day-grid (month) click -> show form for all-day on that date
          const isTimeGrid = info.view.type.startsWith('timeGrid');
          el("event-form").classList.remove("hidden");
          el("event-id").value = "";
          el("event-title").value = "";
          el("event-date-start").value = info.dateStr.substring(0,10);
          el("event-date-end").value = info.dateStr.substring(0,10);
          // If time grid, prefill time (default 1-hour)
          if (isTimeGrid) {
            const d = info.date; // JS Date
            const hh = String(d.getHours()).padStart(2,'0');
            const mm = String(d.getMinutes()).padStart(2,'0');
            el("event-time-start").value = `${hh}:${mm}`;
            const end = new Date(d.getTime()+60*60*1000);
            el("event-time-end").value = `${String(end.getHours()).padStart(2,'0')}:${String(end.getMinutes()).padStart(2,'0')}`;
          } else {
            el("event-time-start").value = "";
            el("event-time-end").value = "";
          }
        },

        // NEW: selecting a range in Day view will set start/end
        select: (info) => {
          if (!auth.currentUser) return;
          const isTimeGrid = info.view.type.startsWith('timeGrid');
          el("event-form").classList.remove("hidden");
          el("event-id").value = "";
          el("event-title").value = "";
          el("event-date-start").value = info.startStr.substring(0,10);
          el("event-date-end").value = info.startStr.substring(0,10);

          if (isTimeGrid) {
            // selection carries times
            const s = new Date(info.start);
            const e = new Date(info.end);
            el("event-time-start").value = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
            el("event-time-end").value   = `${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`;
          } else {
            el("event-time-start").value = "";
            el("event-time-end").value = "";
          }
        },

        eventClick: (info) => {
          if (!auth.currentUser) { showStatus("Please log in to delete.", false); return; }
          if (confirm("Delete this event?")) {
            remove(ref(db, "events/" + info.event.id))
              .then(() => { info.event.remove(); showStatus("Deleted.", true); })
              .catch((e) => showStatus(e.message, false));
          }
        }
      });
      calendar.render();

      // Switchers
      el('btn-month').onclick = () => calendar.changeView('dayGridMonth');
      el('btn-day').onclick   = () => calendar.changeView('timeGridDay');
    });

    // AUTH
    el("btn-signup").onclick = () => {
      const email = el("auth-email").value.trim();
      const password = el("auth-password").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((u) => { authStatusEl.textContent = "Signed up as " + (u.user.email || ""); showStatus("Signed up.", true); })
        .catch((e) => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };

    el("btn-login").onclick = () => {
      const email = el("auth-email").value.trim();
      const password = el("auth-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then((u) => { authStatusEl.textContent = "Welcome, " + (u.user.email || ""); showStatus("Logged in.", true); })
        .catch((e) => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };

    el("btn-google").onclick = async () => {
      try {
        if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else { await signInWithPopup(auth, googleProvider); showStatus("Logged in with Google.", true); }
      } catch (e) {
        if (e?.code === 'auth/popup-blocked') {
          try { await signInWithRedirect(auth, googleProvider); } catch (err) { showStatus(err.message, false); }
        } else showStatus(e.message, false);
      }
    };

    el("btn-logout").onclick = () => {
      signOut(auth).then(() => {
        authStatusEl.textContent = "Logged out.";
        showStatus("Logged out.", true);
        calendar.removeAllEvents();
        el("event-form").classList.add("hidden");
        el("toolbar").classList.add("hidden");
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authStatusEl.textContent = "Welcome, " + (user.email || "");
        el("event-form").classList.remove("hidden");
        el("toolbar").classList.remove("hidden");
        loadEvents(true);
      } else {
        authStatusEl.textContent = "";
        el("event-form").classList.add("hidden");
        el("toolbar").classList.add("hidden");
        calendar && calendar.removeAllEvents();
      }
    });

    el("btn-save").onclick = () => saveEvent();
    el("btn-cancel").onclick = () => el("event-form").classList.add("hidden");
    el("btn-refresh").onclick = () => loadEvents(false);

    // Helpers
    function addDays(ymd, days) {
      const d = new Date(ymd + "T00:00:00");
      d.setDate(d.getDate() + days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function saveEvent() {
      if (!auth.currentUser) { showStatus("Please log in to save.", false); return; }

      const id = el("event-id").value || Date.now().toString();
      const title = el("event-title").value.trim();
      const startDate = el("event-date-start").value;
      const endDateInc = el("event-date-end").value;

      const startTime = el("event-time-start").value; // "HH:MM" or ""
      const endTime   = el("event-time-end").value;   // "HH:MM" or ""

      if (!title || !startDate) { showStatus("Title and start date are required.", false); return; }

      let event = { id, title };

      // Timed event if a start time is provided
      if (startTime) {
        const startISO = `${startDate}T${startTime}`;
        let endISO;
        if (endTime) {
          endISO = `${endDateInc || startDate}T${endTime}`;
        } else {
          // default 1 hour
          const d = new Date(startISO);
          d.setHours(d.getHours()+1);
          endISO = d.toISOString().slice(0,16);
        }
        event.start = startISO;
        event.end = endISO;
        event.allDay = false;
      } else {
        // All-day (your existing behavior)
        event.start = startDate;
        event.allDay = true;
        if (endDateInc && endDateInc >= startDate) {
          event.end = addDays(endDateInc, 1); // exclusive end for all-day
        }
      }

      set(ref(db, "events/" + id), event)
        .then(() => { el("event-form").classList.add("hidden"); showStatus("Saved!", true); return loadEvents(false); })
        .catch((e) => showStatus(e.message, false));
    }

    function normalizeEvent(obj) {
      // Accept legacy/all-day or timed
      const e = { id: obj.id || String(Date.now()), title: obj.title };
      e.allDay = obj.allDay === false ? false : true;

      // Use provided start/end as-is
      e.start = obj.start || obj.date;
      if (obj.end) e.end = obj.end;

      // Auto-detect timed vs all-day if missing allDay flag
      if (!obj.allDay && typeof e.start === 'string' && e.start.includes('T')) {
        e.allDay = false;
      }
      return e;
    }

    function isValidEvent(e) {
      if (!e || typeof e.title !== 'string' || !e.title.trim()) return false;
      if (typeof e.start !== 'string') return false;
      // allow YYYY-MM-DD or YYYY-MM-DDTHH:MM
      if (!/^\d{4}-\d{2}-\d{2}([T ]\d{2}:\d{2})?$/.test(e.start)) return false;
      if (e.end && !/^\d{4}-\d{2}-\d{2}([T ]\d{2}:\d{2})?$/.test(e.end)) return false;
      return true;
    }

    async function loadEvents(isInitial) {
      if (!auth.currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const raw = Object.values(data);
        let ok=0, bad=0;
        const events = [];

        for (const obj of raw) {
          const e = normalizeEvent(obj);
          if (isValidEvent(e)) { events.push(e); ok++; }
          else { bad++; }
        }

        calendar.removeAllEvents();
        calendar.addEventSource(events);

        const msg = `Loaded ${ok} event(s)` + (bad ? `, skipped ${bad}` : '');
        showStatus(msg, true);

        if (isInitial && ok===0 && raw.length>0) {
          showStatus("Found events, but none valid to display. Check fields.", false);
        }
      } catch (e) {
        console.error(e);
        showStatus(e.message || "Failed to load events.", false);
      }
    }
  </script>
</body>
</html>