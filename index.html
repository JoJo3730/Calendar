<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="family-icon-192x192.png" />

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root{--ok:#0a7a0a;--err:#b00020}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;padding:16px 16px 40px}
    h1{margin:0 0 10px;font-size:28px}
    #auth{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0 8px}
    #auth input{grid-column:1 / -1;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:10px}
    #auth button{padding:12px;border-radius:12px;border:1px solid #e6e6e6;background:#fff;font-size:18px}
    #who{margin:8px 0 6px;font-weight:600}
    .row{display:flex;gap:10px;margin:6px 0 12px}
    .row > button{flex:1;padding:12px 10px;border-radius:14px;border:1px solid #e6e6e6;background:#fff;font-size:18px}
    #calendar{max-width:980px;margin:10px auto}
    #status{margin:8px 0;font-size:14px}
    #status.ok{color:var(--ok)} #status.err{color:var(--err)} .hidden{display:none}
    /* Event form */
    #form{max-width:980px;margin:10px auto;background:#f7f7f7;border-radius:12px;padding:12px}
    #form h3{margin:0 0 8px}
    label{display:block;margin-top:8px;font-size:14px}
    input[type="text"],input[type="date"],input[type="time"]{width:100%;padding:10px;font-size:16px;border:1px solid #ddd;border-radius:10px;box-sizing:border-box}
    .form-row{display:flex;gap:10px}
    .form-row > div{flex:1}
    .form-buttons{display:flex;gap:10px;margin-top:10px}
    .form-buttons button{flex:1;padding:12px;border-radius:12px;border:1px solid #e6e6e6;background:#fff;font-size:18px}
    footer{max-width:980px;margin:24px auto 0;text-align:center;color:#666}
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <!-- Auth -->
  <div id="auth">
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <input id="pass" type="password" placeholder="Password" autocomplete="current-password">
    <button id="btnSignup">Sign Up</button>
    <button id="btnLogin">Log In</button>
    <button id="btnGoogle">Sign in with Google</button>
    <button id="btnLogout" class="hidden">Log Out</button>
  </div>
  <div id="who" class="hidden"></div>

  <!-- Top toolbar -->
  <div class="row">
    <button id="btnRefresh">Refresh</button>
    <button id="btnMonth">Month</button>
    <button id="btnWeek">Week</button>
    <button id="btnDay">Day</button>
  </div>

  <!-- Status -->
  <div id="status" class="hidden"></div>

  <!-- Add / Edit form -->
  <div id="form" class="hidden">
    <h3>Add / Edit Event</h3>
    <input type="hidden" id="evId">
    <label>Title:
      <input id="evTitle" type="text" placeholder="e.g., Vacation">
    </label>
    <div class="form-row">
      <div>
        <label>Start Date:
          <input id="evStartDate" type="date">
        </label>
      </div>
      <div>
        <label>End Date (optional, inclusive):
          <input id="evEndDate" type="date">
        </label>
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Start Time (optional):
          <input id="evStartTime" type="time">
        </label>
      </div>
      <div>
        <label>End Time (optional):
          <input id="evEndTime" type="time">
        </label>
      </div>
    </div>
    <div class="form-buttons">
      <button id="btnSave">Save</button>
      <button id="btnDelete">Delete</button>
      <button id="btnCancel">Cancel</button>
    </div>
  </div>

  <div id="calendar"></div>

  <footer>Version: v1.4.0</footer>

  <!-- Firebase (modular) -->
  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getDatabase, ref, get, set, remove} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Firebase config (your project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    const $ = id => document.getElementById(id);
    const status = $('status'), who = $('who'), formBox = $('form');

    function toast(msg, ok=true){
      status.textContent = msg;
      status.classList.remove('hidden','ok','err');
      status.classList.add(ok?'ok':'err');
      setTimeout(()=>status.classList.add('hidden'), ok?2200:4500);
    }

    // --- FullCalendar setup ---
    let calendar;
    function dayNumberOnly(arg){
      // only show day-of-month, used for week header
      return { html: `<div style="font-weight:600">${arg.date.getDate()}</div>` };
    }

    function makeCalendar(){
      calendar = new FullCalendar.Calendar($('calendar'), {
        initialView: 'dayGridMonth',
        height: 'auto',
        // Month view: always render 6 weeks
        fixedWeekCount: true,
        views: {
          dayGridMonth: {
            fixedWeekCount: true
          },
          timeGridWeek: {
            // Week header shows only day number
            dayHeaderContent: dayNumberOnly,
            slotMinTime: "00:00:00",
            slotMaxTime: "24:00:00"
          },
          timeGridDay: {
            slotMinTime: "00:00:00",
            slotMaxTime: "24:00:00"
          }
        },
        dateClick(info){
          if(!auth.currentUser){ toast('Please log in to add.', false); return; }
          openForm({ start: info.dateStr });
        },
        eventClick(info){
          if(!auth.currentUser){ toast('Please log in to edit.', false); return; }
          const e = info.event;
          openForm({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            allDay: e.allDay
          });
        }
      });
      calendar.render();
    }

    // --- Form helpers ---
    function ymd(d){ // returns YYYY-MM-DD
      const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function addDays(ymdStr, n){
      const d=new Date(ymdStr+"T00:00:00"); d.setDate(d.getDate()+n); return ymd(d);
    }
    function openForm({id='', title='', start='', end='', allDay=true}){
      $('evId').value = id;
      $('evTitle').value = title || '';
      let sDate = '', sTime = '', eDate = '', eTime = '';
      if(start){
        const s = (start instanceof Date)? start : new Date(start);
        sDate = ymd(s);
        sTime = (!allDay && start instanceof Date)? s.toTimeString().slice(0,5) : '';
      }
      if(end){
        const e = (end instanceof Date)? end : new Date(end);
        // FullCalendar exclusive end for all-day; adjust back one for display if no times
        if(allDay && (!sTime && !(e instanceof Date && e.getHours()+e.getMinutes()>0))){
          e.setDate(e.getDate()-1);
        }
        eDate = ymd(e);
        eTime = (!allDay && end instanceof Date)? e.toTimeString().slice(0,5) : '';
      }
      $('evStartDate').value = sDate || ymd(new Date());
      $('evEndDate').value   = eDate || sDate || ymd(new Date());
      $('evStartTime').value = sTime;
      $('evEndTime').value   = eTime;
      formBox.classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }
    function closeForm(){ formBox.classList.add('hidden'); }

    async function loadEvents(){
      if(!auth.currentUser) return;
      const snap = await get(ref(db,"events"));
      const data = snap.val() || {};
      const list = Object.values(data);
      const events = list.map(obj=>{
        // support both all-day and timed
        const e = { id: obj.id, title: obj.title };
        if(obj.startTime){ // timed event
          e.start = obj.start; e.end = obj.end || null; e.allDay = false;
        }else{
          e.start = obj.start;
          e.end = obj.end || null;
          e.allDay = true;
        }
        return e;
      });
      calendar.removeAllEvents();
      calendar.addEventSource(events);
    }

    function collectEventFromForm(){
      const id = $('evId').value || String(Date.now());
      const title = $('evTitle').value.trim();
      const sDate = $('evStartDate').value;
      const eDate = $('evEndDate').value;
      const sTime = $('evStartTime').value;
      const eTime = $('evEndTime').value;

      if(!title || !sDate){ toast("Title and start date are required.", false); return null; }

      let allDay = !(sTime && eTime); // both times present -> timed
      let start, end;

      if(allDay){
        start = sDate;
        if(eDate && eDate >= sDate) end = addDays(eDate, 1); // exclusive end
      }else{
        start = `${sDate}T${sTime}`;
        end   = `${eDate || sDate}T${eTime}`;
      }

      const record = { id, title, start };
      if(end) record.end = end;
      if(!allDay){ record.startTime = sTime; record.endTime = eTime; } // markers for loader

      return { id, record, forCalendar: { id, title, start, end: end || null, allDay } };
    }

    // --- Wire buttons ---
    $('btnSave').onclick = async ()=>{
      if(!auth.currentUser){ toast('Please log in.', false); return; }
      const pkg = collectEventFromForm(); if(!pkg) return;
      await set(ref(db,"events/"+pkg.id), pkg.record);
      await loadEvents(); closeForm(); toast('Saved!', true);
    };
    $('btnDelete').onclick = async ()=>{
      const id = $('evId').value;
      if(!id){ closeForm(); return; }
      if(!confirm('Delete this event?')) return;
      await remove(ref(db,"events/"+id));
      await loadEvents(); closeForm(); toast('Deleted.', true);
    };
    $('btnCancel').onclick = closeForm;

    $('btnRefresh').onclick = ()=> loadEvents();
    $('btnMonth').onclick   = ()=> calendar.changeView('dayGridMonth');
    $('btnWeek').onclick    = ()=> calendar.changeView('timeGridWeek');
    $('btnDay').onclick     = ()=> calendar.changeView('timeGridDay');

    // --- Auth UI ---
    $('btnSignup').onclick = async ()=>{
      try{
        await createUserWithEmailAndPassword(auth, $('email').value.trim(), $('pass').value);
      }catch(e){ toast(e.message || 'Sign up failed', false); }
    };
    $('btnLogin').onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, $('email').value.trim(), $('pass').value);
      }catch(e){ toast(e.message || 'Login failed', false); }
    };
    $('btnGoogle').onclick = async ()=>{
      try{
        if(isIOS || isSafari){ await signInWithRedirect(auth, googleProvider); }
        else{ await signInWithPopup(auth, googleProvider); }
      }catch(e){ toast(e.message || 'Google sign-in failed', false); }
    };
    $('btnLogout').onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      const loginIds = ['email','pass','btnSignup','btnLogin','btnGoogle'];
      if(user){
        who.textContent = `Welcome, ${user.email || ''}`;
        who.classList.remove('hidden');
        loginIds.forEach(id=>$(id).classList.add('hidden'));
        $('btnLogout').classList.remove('hidden');
        await loadEvents();
      }else{
        who.classList.add('hidden');
        loginIds.forEach(id=>$(id).classList.remove('hidden'));
        $('btnLogout').classList.add('hidden');
        calendar && calendar.removeAllEvents();
      }
    });

    // --- Init ---
    makeCalendar();
    // handle redirect result (Google on iOS/Safari)
    getRedirectResult(auth).catch(()=>{});
  </script>
</body>
</html>