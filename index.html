<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar (month + day/time grid + selection) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA niceties (optional icons/manifest) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --muted:#666; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding: 16px; }
    h2 { margin: 0 0 16px; }
    .hidden { display:none !important; }

    /* Auth */
    #auth { margin: 8px 0 12px; }
    #auth input { width:100%; padding:10px; font-size:16px; margin:6px 0; box-sizing:border-box; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > button { flex:1 1 140px; }

    /* Status banner */
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }

    /* Event form */
    #form { background:#f5f5f5; padding:12px; border-radius:10px; margin:12px 0; }
    #form h3 { margin:0 0 10px; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"], button { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .form-actions { display:flex; gap:8px; margin-top:10px; }
    .danger { background:#ffeaea; border:1px solid #e99; color:#900; }
    .secondary { background:#fff; border:1px solid #d0d0d0; }

    /* Calendar & toolbar */
    #toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0; }
    #toolbar .spacer { flex:1; }
    #calendar { max-width: 950px; margin: 0 auto; }

    /* Footer */
    #meta { color:var(--muted); font-size:12px; text-align:center; margin-top:20px; }
  </style>
</head>
<body>
  <h2>ðŸ‘ª Family Calendar</h2>

  <!-- Auth -->
  <div id="auth">
    <input type="email" id="email" placeholder="Email" autocomplete="username">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="btn-signup">Sign Up</button>
      <button id="btn-login">Log In</button>
      <button id="btn-google" class="secondary">Sign in with Google</button>
      <button id="btn-logout" class="secondary">Log Out</button>
    </div>
    <p id="hello" class="hidden"></p>
  </div>

  <!-- Status messages -->
  <div id="status" class="hidden"></div>

  <!-- Add / Edit form -->
  <div id="form" class="hidden">
    <h3>Add / Edit Event</h3>
    <input type="hidden" id="event-id">
    <label for="title">Title:</label>
    <input type="text" id="title" placeholder="e.g., Vacation">

    <div class="row">
      <div style="flex:1">
        <label for="date-start">Start Date:</label>
        <input type="date" id="date-start">
      </div>
      <div style="flex:1">
        <label for="date-end">End Date (optional, inclusive):</label>
        <input type="date" id="date-end">
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label for="time-start">Start Time (optional):</label>
        <input type="time" id="time-start" step="900">
      </div>
      <div style="flex:1">
        <label for="time-end">End Time (optional):</label>
        <input type="time" id="time-end" step="900">
      </div>
    </div>

    <div class="form-actions">
      <button id="btn-save">Save</button>
      <button id="btn-cancel" class="secondary">Cancel</button>
      <button id="btn-delete" class="danger hidden">Delete</button>
    </div>
  </div>

  <!-- Calendar toolbar -->
  <div id="toolbar" class="hidden">
    <button id="btn-refresh" class="secondary">Refresh</button>
    <div class="spacer"></div>
    <button id="btn-month" class="secondary">Month</button>
    <button id="btn-day" class="secondary">Day</button>
  </div>

  <!-- Calendar -->
  <div id="calendar"></div>

  <div id="meta">Version: v1.2.0</div>

  <!-- Firebase (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Your Firebase project ---
    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    // --- Firebase init ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // --- quick DOM helpers ---
    const el = id => document.getElementById(id);
    const show = (n, on=true) => el(n).classList.toggle('hidden', !on);
    const status = (msg, ok=false) => {
      const s = el('status');
      s.textContent = msg;
      s.className = ok ? 'ok' : 'err';
      s.classList.remove('hidden');
      setTimeout(() => s.classList.add('hidden'), ok ? 2000 : 6000);
    };

    const isIOS    = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // --- calendar setup ---
    let calendar;
    let editingId = null; // if set, the form is in "edit" mode

    // date helpers
    const pad = n => String(n).padStart(2,'0');
    function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function addDays(ymd, days){
      const d = new Date(ymd + 'T00:00:00'); d.setDate(d.getDate() + days); return toISODate(d);
    }
    function combine(ymd, hm){ return hm ? `${ymd}T${hm}` : null; }

    function prefillForm({id=null, title='', startDate='', endDate='', startTime='', endTime='', showDelete=false}){
      editingId = id;
      el('event-id').value = id || '';
      el('title').value = title || '';
      el('date-start').value = startDate || '';
      el('date-end').value   = endDate   || startDate || '';
      el('time-start').value = startTime || '';
      el('time-end').value   = endTime   || '';
      show('btn-delete', !!showDelete);
      show('form', true);
      // hint
      if(!title && !startDate) status('Title and start date are required.', false);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try { // handle Google redirect
        const res = await getRedirectResult(auth);
        if(res?.user) { el('hello').textContent = 'Welcome, ' + (res.user.email || ''); show('hello', true); status('Logged in with Google.', true); }
      } catch(e){ /* ignore */ }

      calendar = new FullCalendar.Calendar(el('calendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        selectable: true,
        selectMirror: true,

        // create by selecting on the calendar
        select(info) {
          if(!auth.currentUser){ status('Please log in to add events.', false); return; }
          const isTimed = info.view.type !== 'dayGridMonth'; // if in day view, include times
          prefillForm({
            id: null,
            title: '',
            startDate: toISODate(info.start),
            endDate: toISODate(info.end && info.allDay ? new Date(info.end.getTime()-86400000) : info.start),
            startTime: isTimed && !info.allDay ? info.start.toTimeString().slice(0,5) : '',
            endTime:   isTimed && info.end ? info.end.toTimeString().slice(0,5) : '',
            showDelete: false
          });
        },

        // click on single day (month view)
        dateClick(info) {
          if(!auth.currentUser){ status('Please log in to add events.', false); return; }
          prefillForm({ startDate: info.dateStr, endDate: info.dateStr, showDelete:false });
        },

        // click existing event -> EDIT (and optional delete)
        eventClick(info) {
          if(!auth.currentUser){ status('Please log in to modify.', false); return; }
          const e = info.event;
          const allDay = e.allDay;

          // work out inclusive end date for all-day events
          let startDate = toISODate(e.start);
          let endDate   = startDate;
          let startTime = '', endTime = '';

          if(e.end){
            if(allDay){
              // e.end is exclusive; show inclusive date in the form
              endDate = toISODate(new Date(e.end.getTime()-86400000));
            } else {
              endDate = toISODate(e.end);
              endTime = e.end.toTimeString().slice(0,5);
            }
          } else {
            endDate = startDate;
          }
          if(!allDay){
            startTime = e.start.toTimeString().slice(0,5);
          }

          prefillForm({
            id: e.id,
            title: e.title || '',
            startDate, endDate, startTime, endTime,
            showDelete: true
          });
        }
      });

      calendar.render();
    });

    // --- auth UI ---
    function setAuthUI(user){
      if(user){
        el('hello').textContent = 'Welcome, ' + (user.email || '');
        show('hello', true);
        show('auth', false);          // hide the login box
        show('toolbar', true);
        loadEvents(true);
      } else {
        show('auth', true);
        show('hello', false);
        show('toolbar', false);
        show('form', false);
        calendar && calendar.removeAllEvents();
      }
    }

    onAuthStateChanged(auth, setAuthUI);

    el('btn-signup').onclick = () => {
      createUserWithEmailAndPassword(auth, el('email').value.trim(), el('password').value)
        .then(u => { status('Signed up.', true); })
        .catch(e => status(e.message, false));
    };
    el('btn-login').onclick = () => {
      signInWithEmailAndPassword(auth, el('email').value.trim(), el('password').value)
        .then(() => status('Logged in.', true))
        .catch(e => status(e.message, false));
    };
    el('btn-google').onclick = async () => {
      try {
        if(isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else await signInWithPopup(auth, googleProvider);
      } catch(e) {
        if(e?.code === 'auth/popup-blocked'){
          try { await signInWithRedirect(auth, googleProvider); }
          catch(err){ status(err.message, false); }
        } else status(e.message, false);
      }
    };
    el('btn-logout').onclick = () => {
      signOut(auth).then(() => { status('Logged out.', true); setAuthUI(null); });
    };

    // --- toolbar ---
    el('btn-refresh').onclick = () => loadEvents(false);
    el('btn-month').onclick   = () => calendar.changeView('dayGridMonth');
    el('btn-day').onclick     = () => calendar.changeView('timeGridDay');

    // --- Save / Delete / Cancel from form ---
    el('btn-cancel').onclick = () => { show('form', false); editingId = null; };

    el('btn-delete').onclick = async () => {
      const id = editingId || el('event-id').value;
      if(!id) return;
      try {
        await remove(ref(db, 'events/' + id));
        status('Deleted.', true);
        show('form', false);
        editingId = null;
        loadEvents(false);
      } catch(e){ status(e.message, false); }
    };

    el('btn-save').onclick = async () => {
      if(!auth.currentUser){ status('Please log in to save.', false); return; }

      const id   = editingId || el('event-id').value || Date.now().toString();
      const title= el('title').value.trim();
      const ds   = el('date-start').value;
      const de   = el('date-end').value || ds;
      const ts   = el('time-start').value;
      const te   = el('time-end').value;

      if(!title || !ds){ status('Title and start date are required.', false); return; }

      // Build event object for DB + Calendar
      let eventForDB  = { id, title };
      let eventForCal = { id, title };

      if(ts){ // timed event
        const startISO = combine(ds, ts);
        const endISO   = te ? combine(de, te) : combine(ds, ts); // if no end, 0-length
        eventForDB.start = startISO;
        if(endISO) eventForDB.end = endISO;

        eventForCal.start = startISO;
        if(endISO) eventForCal.end = endISO;
        eventForCal.allDay = false;

      } else { // all-day (inclusive end in UI; exclusive end for calendar)
        eventForDB.start = ds;
        if(de && de >= ds){ eventForDB.end = addDays(de, 1); } // store exclusive in DB as well

        eventForCal.start = ds;
        if(de && de >= ds) eventForCal.end = addDays(de, 1);
        eventForCal.allDay = true;
      }

      try {
        await set(ref(db, 'events/' + id), eventForDB);
        status('Saved!', true);
        show('form', false);
        editingId = null;
        loadEvents(false);
      } catch(e){ status(e.message, false); }
    };

    // --- Load events ---
    async function loadEvents(firstLoad){
      if(!auth.currentUser) return;
      try {
        const snap = await get(ref(db, 'events'));
        const data = snap.val() || {};
        const rows = Object.values(data);

        // Normalize rows to FullCalendar event objects
        const events = [];
        for(const r of rows){
          if(!r || !r.title || !r.start) continue;
          const evt = { id:r.id || String(Date.now()), title:r.title };
          // timed vs all-day (simple heuristic)
          const isTimed = r.start.includes('T');
          if(isTimed){
            evt.start = r.start;
            if(r.end) evt.end = r.end;
            evt.allDay = false;
          } else {
            evt.start = r.start;
            if(r.end) evt.end = r.end;  // expected exclusive already
            evt.allDay = true;
          }
          events.push(evt);
        }

        calendar.removeAllEvents();
        calendar.addEventSource(events);
        show('toolbar', true);
        if(firstLoad) status(`Loaded ${events.length} event(s).`, true);
      } catch(e){
        status(e.message || 'Failed to load events.', false);
      }
    }
  </script>
</body>
</html>