<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <!-- Version placeholders (stamped by GitHub Action) -->
  <meta name="app-version" content="%APP_VERSION%">
  <meta name="build-time"  content="%BUILD_TIME%">

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --br:#e0e0e0; }
    * { box-sizing: border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin:0; padding:16px 16px 40px; }
    h1 { margin:0 0 10px; font-size:26px; font-weight:800; }

    /* Auth bar */
    #auth { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:8px 0; }
    #auth input { grid-column:1 / -1; padding:12px; font-size:16px; border:1px solid var(--br); border-radius:10px; }
    #auth .row { grid-column:1 / -1; display:flex; gap:10px; flex-wrap:wrap; }
    #auth .row button { flex:1 1 160px; padding:12px; border-radius:12px; border:1px solid var(--br); background:#fff; font-size:16px; }
    #who { margin:6px 0 10px; font-weight:600; }

    /* Top toolbar */
    #toolbar { display:flex; gap:10px; margin:8px 0 10px; }
    #toolbar button { flex:1 1 140px; padding:12px; border-radius:12px; border:1px solid var(--br); background:#fff; font-size:16px; }

    /* Status */
    #status { margin:6px 0 10px; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }
    .hidden { display:none !important; }

    /* Form card */
    #form { max-width:980px; margin:10px auto; background:#f7f7f7; border-radius:12px; padding:12px; }
    #form h3 { margin:0 0 8px; }
    label { display:block; margin:10px 2px 6px; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"] { width:100%; padding:10px; font-size:16px; border:1px solid var(--br); border-radius:10px; background:#fff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1 1 260px; min-width:240px; }
    .actions { display:flex; gap:10px; margin-top:10px; }
    .actions button { flex:1; padding:12px; border-radius:12px; border:1px solid var(--br); background:#fff; font-size:16px; }
    .muted { color:#6b6b6b; font-size:13px; }
    .chip { border:1px solid #d6d6d6; padding:6px 10px; border-radius:20px; user-select:none; display:inline-flex; align-items:center; gap:6px; }
    #dow-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }

    /* Calendar */
    #calendar { max-width:980px; margin:10px auto; }
    /* Two-line week headers (weekday + day number) */
    .fc .fc-col-header-cell-cushion { display:inline-flex; flex-direction:column; gap:2px; line-height:1.1; }

    footer { max-width:980px; margin:22px auto 0; text-align:center; font-size:12px; color:#888; }
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <!-- Auth -->
  <div id="auth">
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <input id="pass" type="password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="signup">Sign Up</button>
      <button id="login">Log In</button>
      <button id="google">Sign in with Google</button>
      <button id="logout">Log Out</button>
    </div>
    <div id="auth-status" class="muted"></div>
  </div>
  <div id="who" class="hidden"></div>

  <!-- Toolbar -->
  <div id="toolbar">
    <button id="btnRefresh">Refresh</button>
    <button id="btnMonth">Month</button>
    <button id="btnWeek">Week</button>
    <button id="btnDay">Day</button>
  </div>

  <!-- Status -->
  <div id="status" class="hidden"></div>

  <!-- Add / Edit form -->
  <div id="form" class="hidden">
    <h3>Add / Edit Event</h3>
    <input type="hidden" id="evId">

    <label>Title</label>
    <input id="evTitle" type="text" placeholder="e.g., Vacation">

    <div class="row">
      <div>
        <label>Start Date</label>
        <input id="evStartDate" type="date">
      </div>
      <div>
        <label>End Date (optional, inclusive)</label>
        <input id="evEndDate" type="date">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Start Time (optional)</label>
        <input id="evStartTime" type="time">
      </div>
      <div>
        <label>End Time (optional)</label>
        <input id="evEndTime" type="time">
      </div>
    </div>

    <div class="row" style="align-items:center;">
      <div>
        <label class="muted"><input id="repeatWeekly" type="checkbox"> Repeat weekly</label>
      </div>
      <div id="repeatUntilWrap" class="hidden">
        <label>Repeat until (inclusive)</label>
        <input id="repeatUntil" type="date">
      </div>
    </div>

    <div id="dowWrap" class="hidden">
      <div class="muted">Repeat on:</div>
      <div id="dow-list"></div>
    </div>

    <div class="actions">
      <button id="save">Save</button>
      <button id="del">Delete</button>
      <button id="cancel">Cancel</button>
    </div>
  </div>

  <!-- Calendar -->
  <div id="calendar"></div>

  <!-- Version footer -->
  <footer>
    Version: <span id="app-version"></span> | Built: <span id="build-time"></span>
  </footer>

  <!-- Firebase + App -->
  <script type="module">
    /* ===== Version display (stamped by GitHub Action) ===== */
    document.getElementById("app-version").textContent =
      document.querySelector('meta[name="app-version"]')?.content || "v0.0.0";
    document.getElementById("build-time").textContent =
      document.querySelector('meta[name="build-time"]')?.content || "";

    /* ===== Firebase ===== */
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getDatabase, ref, get, set, remove} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    /* ===== DOM helpers ===== */
    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status'), whoEl = $('who'), authBox = $('auth'), formBox = $('form');

    function toast(msg, ok=true){
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','ok','err');
      statusEl.classList.add(ok?'ok':'err');
      setTimeout(()=>statusEl.classList.add('hidden'), ok?2200:4800);
    }

    function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
    function addDays(ymdStr, n){ const d=new Date(ymdStr+"T00:00:00"); d.setDate(d.getDate()+n); return ymd(d); }

    /* ===== FullCalendar ===== */
    let calendar;

    function weekHeaderContent(args){
      // Two-line: weekday short + day number
      const wk = new Intl.DateTimeFormat(undefined, { weekday:'short' }).format(args.date);
      const d  = new Intl.DateTimeFormat(undefined, { day:'numeric' }).format(args.date);
      return { html:`<div>${wk}</div><div>${d}</div>` };
    }

    function buildCalendar(){
      calendar = new FullCalendar.Calendar($('calendar'), {
        initialView: 'dayGridMonth',
        height: 'auto',
        fixedWeekCount: true,               // always 6 rows in month view
        headerToolbar: false,               // we use our own buttons
        dayHeaderFormat: { weekday:'short' },
        views: {
          timeGridWeek: { dayHeaderContent: weekHeaderContent },
          timeGridDay:  {}
        },
        dateClick(info){
          if(!auth.currentUser){ toast('Please log in to add.', false); return; }
          openForm({ startDate: info.dateStr, endDate: info.dateStr });
        },
        eventClick(info){
          if(!auth.currentUser){ toast('Please log in to edit.', false); return; }
          const e = info.event;
          // Recurring?
          const dow = e.extendedProps.daysOfWeek || e._def.recurringDef?.typeData?.daysOfWeek;
          const isRec = Array.isArray(dow) && dow.length;

          if(isRec){
            $('repeatWeekly').checked = true;
            $('repeatUntilWrap').classList.remove('hidden');
            $('dowWrap').classList.remove('hidden');

            // check DOW chips
            document.querySelectorAll('#dow-list input[type=checkbox]').forEach(cb=>{
              cb.checked = dow.includes(parseInt(cb.value));
            });

            const sr = e.extendedProps.startRecur || e._def.recurringDef?.typeData?.startRecur || '';
            const er = e.extendedProps.endRecur   || e._def.recurringDef?.typeData?.endRecur   || '';
            $('evStartDate').value = sr || '';
            $('evEndDate').value = ''; // not used for recurrence
            $('repeatUntil').value = er ? addDays(er, -1) : '';

            $('evStartTime').value = e.extendedProps.startTime || e._def.recurringDef?.typeData?.startTime || '';
            $('evEndTime').value   = e.extendedProps.endTime   || e._def.recurringDef?.typeData?.endTime   || '';
          } else {
            $('repeatWeekly').checked = false;
            $('repeatUntilWrap').classList.add('hidden');
            $('dowWrap').classList.add('hidden');

            const s = e.startStr?.slice(0,10) || '';
            const ex = e.endStr?.slice(0,10) || '';
            $('evStartDate').value = s;
            $('evEndDate').value   = ex ? addDays(ex, -1) : s;

            $('evStartTime').value = e.extendedProps.startTime || '';
            $('evEndTime').value   = e.extendedProps.endTime   || '';
          }

          $('evId').value = e.id || '';
          $('evTitle').value = e.title || '';
          formBox.classList.remove('hidden');
          info.jsEvent.preventDefault();
        }
      });
      calendar.render();
    }

    /* ===== Form helpers ===== */
    function openForm({id='', title='', startDate='', endDate='', startTime='', endTime=''}){
      $('evId').value = id;
      $('evTitle').value = title;
      $('evStartDate').value = startDate || ymd(new Date());
      $('evEndDate').value = endDate || $('evStartDate').value;
      $('evStartTime').value = startTime || '';
      $('evEndTime').value = endTime || '';
      $('repeatWeekly').checked = false;
      $('repeatUntil').value = '';
      $('repeatUntilWrap').classList.add('hidden');
      $('dowWrap').classList.add('hidden');
      formBox.classList.remove('hidden');
      formBox.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function collectEvent(){
      const id = $('evId').value || String(Date.now());
      const title = $('evTitle').value.trim();
      const sDate = $('evStartDate').value;
      const eDateInc = $('evEndDate').value;
      const sTime = $('evStartTime').value.trim();
      const eTime = $('evEndTime').value.trim();
      const rec = $('repeatWeekly').checked;
      const untilInc = $('repeatUntil').value;

      if(!title || !sDate){ toast('Title and start date are required.', false); return null; }

      if(rec){
        const days = Array.from(document.querySelectorAll('#dow-list input[type=checkbox]'))
                          .filter(cb=>cb.checked).map(cb=>parseInt(cb.value));
        if(!days.length){ toast('Pick at least one weekday for the weekly repeat.', false); return null; }
        const event = { id, title, daysOfWeek: days, startRecur: sDate };
        if(untilInc) event.endRecur = addDays(untilInc, 1); // exclusive
        if(sTime) event.startTime = sTime;
        if(eTime) event.endTime   = eTime;
        event.allDay = !(sTime && eTime);
        return { id, record:event };
      }

      // single event
      const allDay = !(sTime && eTime);
      const event = { id, title, allDay };
      event.start = allDay ? sDate : `${sDate}T${sTime}`;
      if(eDateInc){
        if(allDay) event.end = addDays(eDateInc, 1);
        else if(eTime) event.end = `${eDateInc}T${eTime}`;
      }
      if(sTime) event.startTime = sTime;
      if(eTime) event.endTime   = eTime;
      return { id, record:event };
    }

    async function loadEvents(){
      if(!auth.currentUser) return;
      const snap = await get(ref(db,"events"));
      const data = snap.val() || {};
      const events = Object.values(data);
      calendar.removeAllEvents();
      calendar.addEventSource(events);
      toast(`Loaded ${events.length} event(s)`);
    }

    /* ===== Wire UI ===== */
    // Build DOW chips
    (function buildDOW(){
      const labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const wrap = document.createDocumentFragment();
      labels.forEach((lbl, idx)=>{
        const lab = document.createElement('label');
        lab.className = 'chip';
        lab.innerHTML = `<input type="checkbox" value="${idx}">${lbl}`;
        wrap.appendChild(lab);
      });
      $('dow-list').appendChild(wrap);
    })();

    $('repeatWeekly').addEventListener('change', ()=>{
      $('repeatUntilWrap').classList.toggle('hidden', !$('repeatWeekly').checked);
      $('dowWrap').classList.toggle('hidden', !$('repeatWeekly').checked);
    });

    // Toolbar
    $('btnRefresh').onclick = ()=> loadEvents();
    $('btnMonth').onclick   = ()=> calendar.changeView('dayGridMonth');
    $('btnWeek').onclick    = ()=> calendar.changeView('timeGridWeek');
    $('btnDay').onclick     = ()=> calendar.changeView('timeGridDay');

    // Form buttons
    $('save').onclick = async ()=>{
      if(!auth.currentUser){ toast('Please log in.', false); return; }
      const pkg = collectEvent(); if(!pkg) return;
      await set(ref(db, "events/"+pkg.id), pkg.record);
      await loadEvents();
      formBox.classList.add('hidden');
      toast('Saved!');
    };
    $('del').onclick = async ()=>{
      const id = $('evId').value;
      if(!id){ formBox.classList.add('hidden'); return; }
      if(!confirm('Delete this event?')) return;
      await remove(ref(db, "events/"+id));
      await loadEvents();
      formBox.classList.add('hidden');
      toast('Deleted.');
    };
    $('cancel').onclick = ()=> formBox.classList.add('hidden');

    // Auth
    $('signup').onclick = async ()=>{
      try{
        await createUserWithEmailAndPassword(auth, $('email').value.trim(), $('pass').value);
      }catch(e){ toast(e.message || 'Sign up failed', false); }
    };
    $('login').onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, $('email').value.trim(), $('pass').value);
      }catch(e){ toast(e.message || 'Login failed', false); }
    };
    $('google').onclick = async ()=>{
      try{
        if(isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else await signInWithPopup(auth, googleProvider);
      }catch(e){
        if(e?.code === 'auth/popup-blocked'){ await signInWithRedirect(auth, googleProvider); }
        else toast(e.message || 'Google sign-in failed', false);
      }
    };
    $('logout').onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        $('auth-status').textContent = `Welcome, ${user.email || ''}`;
        whoEl.textContent = `Signed in as ${user.email || ''}`;
        whoEl.classList.remove('hidden');
        authBox.classList.add('hidden');
        await loadEvents();
      }else{
        $('auth-status').textContent = '';
        whoEl.classList.add('hidden');
        authBox.classList.remove('hidden');
        calendar && calendar.removeAllEvents();
      }
    });

    // Handle Google redirect on iOS/Safari
    getRedirectResult(auth).catch(()=>{});

    // Boot calendar
    buildCalendar();
  </script>
</body>
</html>