<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA (optional) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <!-- Version placeholders (for your GitHub Action stamping, optional) -->
  <meta name="app-version" content="%APP_VERSION%">
  <meta name="build-time"  content="%BUILD_TIME%">

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --br:#e0e0e0; --btn:#f4f6f9; }
    * { box-sizing: border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin:0; padding:16px 16px 40px; }
    h1 { margin:0 0 10px; font-size:26px; font-weight:800; }

    /* Top auth strip */
    #authTop { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; flex-wrap:wrap; }
    #signedIn { display:none; align-items:center; gap:10px; }
    #signedIn .email { font-weight:600; }
    #logoutBtn { padding:6px 10px; border-radius:10px; border:1px solid var(--br); background:#fff; cursor:pointer; }

    /* Login form (only when signed out) */
    #loginForm { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:8px 0; }
    #loginForm input { padding:10px; font-size:16px; border:1px solid var(--br); border-radius:10px; }
    #loginForm button { padding:10px 14px; border-radius:12px; border:1px solid var(--br); background:#fff; font-size:16px; cursor:pointer; }

    /* Toolbar + Title row */
    #toolbar { display:none; gap:10px; margin:10px 0; }
    #toolbar button { padding:10px 14px; border-radius:12px; border:1px solid var(--br); background:var(--btn); font-size:16px; flex:1 1 140px; }
    #cal-title-row { display:none; align-items:center; gap:12px; margin:10px 0 8px; }
    #cal-title-row button { padding:.5rem .75rem; border-radius:10px; border:1px solid var(--br); background:#fff; }
    #cal-title { font-weight:900; font-size:2rem; line-height:1; }

    /* Status toast */
    #status { margin:6px 0 10px; font-size:14px; display:none; }
    #status.ok { color:var(--ok); } #status.err { color:var(--err); }

    /* Event form card */
    #form { display:none; max-width:980px; background:#f7f7f7; border-radius:12px; padding:12px; margin:10px 0; }
    #form h3 { margin:0 0 8px; }
    label { display:block; margin:10px 2px 6px; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"] { width:100%; padding:10px; font-size:16px; border:1px solid var(--br); border-radius:10px; background:#fff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1 1 260px; min-width:240px; }
    .actions { display:flex; gap:10px; margin-top:10px; }
    .actions button { flex:1; padding:12px; border-radius:12px; border:1px solid var(--br); background:#fff; font-size:16px; cursor:pointer; }

    /* Calendar */
    #calendar { max-width:980px; }
    .fc { --fc-border-color:#e6ebf2; }
    .fc-daygrid-day-number { font-weight:600; }

    /* Color legend */
    #legend { display:none; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0 4px; }
    .legend-item { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--br); border-radius:20px; background:#fff; }
    .legend-dot { width:14px; height:14px; border-radius:50%; border:1px solid #999; }

    footer { margin-top:20px; text-align:center; font-size:12px; color:#888; }
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <!-- Top auth strip -->
  <div id="authTop">
    <!-- Shown only when signed OUT -->
    <div id="loginForm">
      <input id="email" type="email" placeholder="Email" autocomplete="username">
      <input id="pass" type="password" placeholder="Password" autocomplete="current-password">
      <button id="signup">Sign Up</button>
      <button id="login">Log In</button>
      <button id="google">Sign in with Google</button>
    </div>

    <!-- Shown only when signed IN -->
    <div id="signedIn">
      <span>Signed in as <span class="email" id="who"></span></span>
      <button id="logoutBtn">Log Out</button>
    </div>
  </div>

  <!-- View toolbar (only when signed in) -->
  <div id="toolbar">
    <button id="btnRefresh">Refresh</button>
    <button id="btnMonth">Month</button>
    <button id="btnWeek">Week</button>
    <button id="btnDay">Day</button>
  </div>

  <!-- Custom title + arrows (only when signed in) -->
  <div id="cal-title-row">
    <button id="btn-prev" aria-label="Previous">â€¹</button>
    <button id="btn-today" aria-label="Today">today</button>
    <button id="btn-next" aria-label="Next">â€º</button>
    <div id="cal-title"></div>
  </div>

  <!-- Per-user color legend -->
  <div id="legend"></div>

  <!-- Status -->
  <div id="status"></div>

  <!-- Add / Edit form -->
  <div id="form">
    <h3>Add / Edit Event</h3>
    <input type="hidden" id="evId">

    <label>Title</label>
    <input id="evTitle" type="text" placeholder="e.g., Vacation">

    <div class="row">
      <div>
        <label>Start Date</label>
        <input id="evStartDate" type="date">
      </div>
      <div>
        <label>End Date (optional, inclusive)</label>
        <input id="evEndDate" type="date">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Start Time (optional)</label>
        <input id="evStartTime" type="time" step="60">
      </div>
      <div>
        <label>End Time (optional)</label>
        <input id="evEndTime" type="time" step="60">
      </div>
    </div>

    <div class="actions">
      <button id="save">Save</button>
      <button id="del">Delete</button>
      <button id="cancel">Cancel</button>
    </div>
  </div>

  <!-- Calendar -->
  <div id="calendar"></div>

  <!-- Version footer -->
  <footer>
    Version: <span id="app-version"></span> | Built: <span id="build-time"></span>
  </footer>

  <!-- Firebase (modular) + App -->
  <script type="module">
    /* ========= Version display ========= */
    const APP_VERSION = document.querySelector('meta[name="app-version"]')?.content || 'v0.0.0';
    const BUILD_TIME  = document.querySelector('meta[name="build-time"]')?.content || '';
    document.getElementById('app-version').textContent = APP_VERSION;
    document.getElementById('build-time').textContent  = BUILD_TIME;

    /* ========= Firebase ========= */
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getDatabase, ref, get, set, remove} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    /* ========= DOM helpers ========= */
    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');
    function toast(msg, ok=true){
      statusEl.textContent = msg;
      statusEl.classList.remove('ok','err');
      statusEl.classList.add(ok ? 'ok' : 'err');
      statusEl.style.display = 'block';
      setTimeout(()=>{ statusEl.style.display='none'; }, ok ? 2200 : 4800);
    }

    /* ========= User color mapping =========
       Edit this to assign family colors by email address.
       Any user not listed here will get a deterministic fallback color.
    */
    const USER_COLORS = Object.freeze({
      // "jojo@example.com": "#e57373",
      // "lovi@example.com": "#64b5f6",
      // "maimai@example.com": "#81c784",
      // "carol@example.com": "#ba68c8",
      // "jase@example.com": "#ffb74d",
      // "lb@example.com":   "#4db6ac",
    });

    // Deterministic fallback: hash string -> HSL color
    function colorFromString(str){
      let h=0; for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
      const hue = h % 360;
      return `hsl(${hue} 70% 70%)`;
    }

    function labelFromEmail(email){
      if(!email) return 'unknown';
      const name = email.split('@')[0] || email;
      return name.replace(/[._]/g,' ').toLowerCase();
    }

    // Build/update legend chips from a set of {email: color}
    function renderLegend(colorMap){
      const legend = $('legend');
      legend.innerHTML = '';
      const entries = Object.entries(colorMap);
      if (!entries.length) { legend.style.display='none'; return; }
      for(const [email,color] of entries){
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<span class="legend-dot" style="background:${color}"></span><span>${labelFromEmail(email)}</span>`;
        legend.appendChild(item);
      }
      legend.style.display = 'flex';
    }

    /* ========= Calendar ========= */
    let calendar;

    function addDays(ymdStr, n){ const d=new Date(ymdStr+"T00:00:00"); d.setDate(d.getDate()+n); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

    function composeEventForSave(id, title, sDate, eDateInc, sTime, eTime){
      const hasTimes = sTime && eTime;
      const allDay = !hasTimes;
      const start = hasTimes ? `${sDate}T${sTime}` : sDate;
      let end = null;
      if (eDateInc) end = hasTimes ? `${eDateInc}T${eTime || sTime}` : addDays(eDateInc, 1); // exclusive end for all-day
      const u = auth.currentUser;
      const base = { id, title, start, allDay, uid: u?.uid || null, email: u?.email || null };
      if (end) base.end = end;
      return base;
    }

    function weekHeaderContent(arg){
      const type = calendar?.view?.type;
      if (type === 'timeGridWeek' || type === 'timeGridDay') {
        const d = arg.date;
        const wd = d.toLocaleString(undefined, { weekday: 'short' }); // Sun
        const m  = d.toLocaleString(undefined, { month: 'short' });   // Aug
        const day= d.getDate();
        return `${wd} ${m} ${day}`;
      }
      return arg.text;
    }

    function formatRange(start, end){
      const endInc = new Date(end.getTime() - 86400000);
      const sm = start.toLocaleString(undefined,{month:'short'});
      const sy = start.toLocaleString(undefined,{year:'numeric'});
      const sd = start.toLocaleString(undefined,{day:'numeric'});
      const em = endInc.toLocaleString(undefined,{month:'short'});
      const ey = endInc.toLocaleString(undefined,{year:'numeric'});
      const ed = endInc.toLocaleString(undefined,{day:'numeric'});
      if (sm===em && sy===ey) return `${sm} ${sd}â€“${ed}, ${sy}`;
      if (sy===ey) return `${sm} ${sd} â€“ ${em} ${ed}, ${sy}`;
      return `${sm} ${sd}, ${sy} â€“ ${em} ${ed}, ${ey}`;
    }

    function updateTitle(){
      if (!calendar) return;
      const v = calendar.view;
      if (v.type === 'dayGridMonth') {
        $('cal-title').textContent = v.currentStart.toLocaleString(undefined, { month: 'long', year:'numeric' });
      } else if (v.type === 'timeGridWeek') {
        $('cal-title').textContent = formatRange(v.currentStart, v.currentEnd);
      } else if (v.type === 'timeGridDay') {
        $('cal-title').textContent = v.currentStart.toLocaleString(undefined, { weekday:'short', month:'short', day:'numeric', year:'numeric' });
      } else {
        $('cal-title').textContent = v.title;
      }
    }

    function buildCalendar(){
      calendar = new FullCalendar.Calendar($('calendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        fixedWeekCount: true,
        height: 'auto',
        dayHeaderContent: weekHeaderContent,
        dateClick(info){
          if(!auth.currentUser){ toast('Please log in to add.', false); return; }
          $('evId').value = '';
          $('evTitle').value = '';
          $('evStartDate').value = info.dateStr;
          $('evEndDate').value   = info.dateStr;
          $('evStartTime').value = '';
          $('evEndTime').value   = '';
          $('form').style.display = 'block';
          if (calendar.view.type === 'timeGridWeek') {
            calendar.changeView('timeGridDay', info.dateStr);
          }
        },
        eventClick(info){
          if(!auth.currentUser){ toast('Please log in to edit.', false); return; }
          const ev = info.event;
          $('evId').value = ev.id || '';
          $('evTitle').value = ev.title || '';

          const startISO = ev.startStr || '';
          const endISO   = ev.endStr || '';
          const allDay   = ev.allDay;

          const [sDate, sTime=''] = startISO.split('T');
          $('evStartDate').value = sDate || '';
          if (allDay) {
            $('evStartTime').value = '';
            $('evEndTime').value   = '';
            $('evEndDate').value   = endISO ? addDays(endISO.slice(0,10), -1) : sDate;
          } else {
            $('evStartTime').value = sTime.slice(0,5);
            if (endISO) {
              const [eDate, eTime=''] = endISO.split('T');
              $('evEndDate').value = eDate || sDate;
              $('evEndTime').value = eTime.slice(0,5);
            } else {
              $('evEndDate').value = sDate;
              $('evEndTime').value = '';
            }
          }

          $('form').style.display = 'block';
          info.jsEvent.preventDefault();
        },
        eventDidMount(info){
          // ensure colors applied (in case not set earlier)
          const email = info.event.extendedProps.email;
          const uid   = info.event.extendedProps.uid;
          const color = USER_COLORS[email] || colorFromString(email || uid || info.event.id);
          info.el.style.backgroundColor = color;
          info.el.style.borderColor = color;
        },
        datesSet(){ updateTitle(); }
      });
      calendar.render();
      updateTitle();

      // Title navigation
      $('btn-prev').onclick  = ()=> calendar.prev();
      $('btn-next').onclick  = ()=> calendar.next();
      $('btn-today').onclick = ()=> calendar.today();

      // Our toolbar
      $('btnRefresh').onclick = ()=> loadEvents();
      $('btnMonth').onclick   = ()=> calendar.changeView('dayGridMonth');
      $('btnWeek').onclick    = ()=> calendar.changeView('timeGridWeek');
      $('btnDay').onclick     = ()=> calendar.changeView('timeGridDay');
    }

    async function loadEvents(){
      if(!auth.currentUser) return;
      const snap = await get(ref(db,"events"));
      const data = snap.val() || {};
      const events = Object.values(data).map(obj => {
        const email = obj.email || '';
        const uid   = obj.uid || '';
        const bg    = USER_COLORS[email] || colorFromString(email || uid || obj.id);
        const title = obj.title; // keep as-is; or `${obj.title} (${labelFromEmail(email)})`
        return {
          id: obj.id,
          title,
          start: obj.start || obj.date,
          end: obj.end,
          allDay: obj.allDay ?? !String(obj.start || '').includes('T'),
          email,
          uid,
          backgroundColor: bg,
          borderColor: bg
        };
      });

      // Build legend from the set of emails seen + predefined map
      const legendMap = {};
      // Pre-seed from USER_COLORS (so even if that user's events aren't on screen, they appear in legend)
      for (const [email,color] of Object.entries(USER_COLORS)) legendMap[email] = color;
      // Include any others from loaded events
      for (const ev of events) {
        const email = ev.email;
        if (!email) continue;
        if (!legendMap[email]) legendMap[email] = ev.backgroundColor;
      }
      renderLegend(legendMap);

      calendar.removeAllEvents();
      calendar.addEventSource(events);
      toast(`Loaded ${events.length} event(s)`);
    }

    // Save/Delete/Cancel
    $('save').onclick = async ()=>{
      if(!auth.currentUser){ toast('Please log in.', false); return; }
      const id    = $('evId').value || String(Date.now());
      const title = $('evTitle').value.trim();
      const sDate = $('evStartDate').value;
      const eDate = $('evEndDate').value;
      const sTime = $('evStartTime').value.trim();
      const eTime = $('evEndTime').value.trim();
      if(!title || !sDate){ toast('Title and start date are required.', false); return; }
      const rec = composeEventForSave(id, title, sDate, eDate, sTime, eTime);
      await set(ref(db, "events/"+id), rec);
      $('form').style.display = 'none';
      await loadEvents();
      toast('Saved!');
    };

    $('del').onclick = async ()=>{
      const id = $('evId').value;
      if(!id){ $('form').style.display='none'; return; }
      if(!confirm('Delete this event?')) return;
      await remove(ref(db, "events/"+id));
      $('form').style.display = 'none';
      await loadEvents();
      toast('Deleted.');
    };

    $('cancel').onclick = ()=> $('form').style.display = 'none';

    /* ========= Auth wiring ========= */
    $('signup').onclick = async ()=>{
      try{
        await createUserWithEmailAndPassword(auth, $('email').value.trim(), $('pass').value);
      }catch(e){ toast(e.message || 'Sign up failed', false); }
    };
    $('login').onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, $('email').value.trim(), $('pass').value);
      }catch(e){ toast(e.message || 'Login failed', false); }
    };
    $('google').onclick = async ()=>{
      try{
        if(isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else await signInWithPopup(auth, googleProvider);
      }catch(e){
        if(e?.code==='auth/popup-blocked'){ await signInWithRedirect(auth, googleProvider); }
        else toast(e.message || 'Google sign-in failed', false);
      }
    };
    $('logoutBtn').onclick = ()=> signOut(auth); // UI toggles without page reload

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        $('loginForm').style.display = 'none';
        $('signedIn').style.display = 'flex';
        $('who').textContent = user.email || '';
        $('toolbar').style.display = 'flex';
        $('cal-title-row').style.display = 'flex';
        if(!calendar) buildCalendar();
        await loadEvents();
      }else{
        $('loginForm').style.display = 'flex';
        $('signedIn').style.display = 'none';
        $('toolbar').style.display = 'none';
        $('cal-title-row').style.display = 'none';
        if(calendar) calendar.removeAllEvents();
        if(!calendar) buildCalendar(); // ensure shell exists
        // clear legend when logged out
        renderLegend({});
      }
    });

    // Handle Google redirect on iOS/Safari quietly
    getRedirectResult(auth).catch(()=>{});

    // Boot calendar shell early so layout exists even when logged out
    buildCalendar();
  </script>
</body>
</html>