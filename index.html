<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA manifest/icon (optional) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; --btn:#edf2f7; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding: 18px; }
    h1 { margin: 0 0 10px; font-size: 1.9rem; }
    #calendar { max-width: 1000px; margin: 10px auto; }
    #auth-row input { width:100%; padding:10px; font-size:16px; margin:6px 0; box-sizing:border-box; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > button { flex:1; min-width: 120px; }
    button { padding:.65rem 1.0rem; font-size:1.05rem; border-radius:10px; border:1px solid #d7dde4; background:var(--btn); }
    .chip { background:#e9eef6; border:0; }
    .hidden { display:none !important; }
    #event-form { background:#f6f7f9; padding:12px; border-radius:10px; margin:12px auto; max-width: 1000px; }
    label { display:block; margin:.35rem 0 .2rem; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"] { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); } #status.err { color:var(--err); }
    #toolbar { display:flex; gap:10px; justify-content:center; margin:12px auto; max-width:1000px; }
    /* Title row with arrows */
    #cal-title-row { display:flex; align-items:center; gap:12px; margin:10px auto 8px; max-width:1000px; }
    #cal-title { font-weight:900; font-size:2.2rem; line-height:1; }
    #btn-prev, #btn-next, #btn-today { background:#eef2f7; }
    /* Ensure full 6 weeks in month view look tidy */
    .fc { --fc-border-color:#e6ebf2; }
    .fc-daygrid-day-number { font-weight:600; }
    footer { text-align:center; color:#6a7280; margin-top:16px; }
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <!-- Auth -->
  <div id="auth-row">
    <div class="row">
      <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
      <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    </div>
    <div class="row">
      <button id="btn-signup">Sign Up</button>
      <button id="btn-login">Log In</button>
      <button id="btn-google" class="chip">Sign in with Google</button>
      <button id="btn-logout" class="chip">Log Out</button>
    </div>
    <p id="auth-status"></p>
  </div>

  <p id="signed-in-as" class="hidden">Signed in as <span id="who"></span></p>

  <!-- Top toolbar -->
  <div id="toolbar" class="hidden">
    <button id="btn-refresh">Refresh</button>
    <button id="btn-month">Month</button>
    <button id="btn-week">Week</button>
    <button id="btn-day">Day</button>
  </div>

  <!-- Title + arrows -->
  <div id="cal-title-row" class="hidden">
    <button id="btn-prev" aria-label="Previous">â€¹</button>
    <button id="btn-today" aria-label="Today">today</button>
    <button id="btn-next" aria-label="Next">â€º</button>
    <div id="cal-title"></div>
  </div>

  <!-- Event form -->
  <div id="event-form" class="hidden">
    <input type="hidden" id="event-id">
    <h3 style="margin:0 0 .4rem;">Add / Edit Event</h3>
    <label>Title:</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <div class="two">
      <div>
        <label>Start Date:</label>
        <input type="date" id="event-date-start">
      </div>
      <div>
        <label>End Date (optional, inclusive):</label>
        <input type="date" id="event-date-end">
      </div>
    </div>

    <div class="two">
      <div>
        <label>Start Time (optional):</label>
        <input type="time" id="event-time-start" step="60">
      </div>
      <div>
        <label>End Time (optional):</label>
        <input type="time" id="event-time-end" step="60">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="btn-save">Save</button>
      <button id="btn-cancel" class="chip">Cancel</button>
    </div>
  </div>

  <div id="status" class="hidden"></div>

  <div id="calendar"></div>

  <footer>
    Version: v1.3.2
  </footer>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // --- Helpers/els ---
    const el = (id) => document.getElementById(id);
    const statusEl = el('status');
    const authStatusEl = el('auth-status');

    function showStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.className = ''; // reset
      statusEl.classList.add(ok ? 'ok':'err');
      statusEl.classList.remove('hidden');
      setTimeout(()=>statusEl.classList.add('hidden'), ok?2200:5000);
    }

    // simple UA helpers (for redirect sign-in on iOS Safari)
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // --- Calendar setup ---
    let calendar;

    // title helpers
    const titleEl = el('cal-title');
    const titleRow = el('cal-title-row');

    function formatRange(start, end, opts) {
      // end is exclusive in week/day views; show inclusive end-1day
      const endInc = new Date(end.getTime() - 24*60*60*1000);
      const mOpts = { month: 'short' };
      const yOpts = { year: 'numeric' };
      const dOpts = { day: 'numeric' };

      const sm = start.toLocaleString(undefined, mOpts);
      const sy = start.toLocaleString(undefined, yOpts);
      const sd = start.toLocaleString(undefined, dOpts);

      const em = endInc.toLocaleString(undefined, mOpts);
      const ey = endInc.toLocaleString(undefined, yOpts);
      const ed = endInc.toLocaleString(undefined, dOpts);

      if (sm === em && sy === ey) return `${sm} ${sd}â€“${ed}, ${sy}`;
      if (sy === ey) return `${sm} ${sd} â€“ ${em} ${ed}, ${sy}`;
      return `${sm} ${sd}, ${sy} â€“ ${em} ${ed}, ${ey}`;
    }

    function updateTitle(info) {
      const view = info?.view || calendar.view;
      if (view.type === 'dayGridMonth') {
        titleEl.textContent = view.currentStart.toLocaleString(undefined, { month: 'long', year: 'numeric' });
      } else if (view.type === 'timeGridWeek') {
        titleEl.textContent = formatRange(view.currentStart, view.currentEnd);
      } else if (view.type === 'timeGridDay') {
        titleEl.textContent = view.currentStart.toLocaleString(undefined, {
          weekday:'short', month:'short', day:'numeric', year:'numeric'
        });
      } else {
        titleEl.textContent = view.title;
      }
    }

    // add/sub days
    function addDays(ymd, days) {
      const d = new Date(ymd + "T00:00:00");
      d.setDate(d.getDate() + days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // Compose ISO strings if time is supplied
    function composeStartEnd(startDate, endDate, startTime, endTime) {
      let allDay = true, start = startDate, end = null;
      const hasStartTime = !!startTime;
      const hasEndTime = !!endTime;

      if (hasStartTime) {
        allDay = false;
        start = `${startDate}T${startTime}`;
        if (endDate) {
          end = hasEndTime ? `${endDate}T${endTime}` : `${endDate}T${startTime}`;
        } else if (hasEndTime) {
          end = `${startDate}T${endTime}`;
        }
      } else {
        // all-day; FullCalendar needs exclusive end when spanning
        if (endDate && endDate >= startDate) end = addDays(endDate, 1);
      }
      return { start, end, allDay };
    }

    function normalizeEvent(obj) {
      const e = {
        id: obj.id,
        title: obj.title,
        start: obj.start || obj.date,
        allDay: obj.allDay ?? !obj.start?.includes('T')
      };
      if (obj.end) e.end = obj.end;
      return e;
    }

    function isValidEvent(e) {
      if (!e || typeof e.title !== 'string' || !e.title.trim()) return false;
      if (typeof e.start !== 'string') return false;
      return true;
    }

    async function loadEvents(showMsg=true) {
      if (!auth.currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const raw = Object.values(data);
        const events = [];
        let ok=0, bad=0;
        for (const obj of raw) {
          const e = normalizeEvent(obj);
          if (isValidEvent(e)) { events.push(e); ok++; } else { bad++; }
        }
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        if (showMsg) showStatus(`Loaded ${ok} event(s)` + (bad?`, skipped ${bad}`:''), true);
      } catch (e) {
        console.error(e);
        showStatus(e.message || "Failed to load events.", false);
      }
    }

    function saveEvent() {
      if (!auth.currentUser) { showStatus("Please log in to save.", false); return; }
      const id = el("event-id").value || Date.now().toString();
      const title = el("event-title").value.trim();
      const sDate = el("event-date-start").value;
      const eDate = el("event-date-end").value;
      const sTime = el("event-time-start").value;
      const eTime = el("event-time-end").value;

      if (!title || !sDate) { showStatus("Title and start date are required.", false); return; }

      const se = composeStartEnd(sDate, eDate, sTime, eTime);
      const payload = { id, title, ...se };

      set(ref(db, "events/" + id), payload)
        .then(async () => {
          el("event-form").classList.add("hidden");
          showStatus("Saved!", true);
          await loadEvents(false);
        })
        .catch((e) => showStatus(e.message, false));
    }

    function openEditForm(eventObj) {
      // Pre-fill form from an existing calendar event
      const ev = eventObj.extendedProps || {};
      const id = eventObj.id;
      const title = eventObj.title || '';
      const startIso = eventObj.startStr;       // ISO
      const endIso = eventObj.endStr || '';
      const allDay = eventObj.allDay;

      el("event-id").value = id;
      el("event-title").value = title;

      const [sDate, sTime] = startIso.split('T');
      el("event-date-start").value = sDate || '';

      if (allDay) {
        // for all-day, stored end is exclusive; give inclusive date back
        if (endIso) {
          const d = new Date(endIso);
          d.setDate(d.getDate()-1);
          el("event-date-end").value = d.toISOString().slice(0,10);
        } else {
          el("event-date-end").value = sDate || '';
        }
        el("event-time-start").value = '';
        el("event-time-end").value = '';
      } else {
        if (endIso) {
          const [eDate, eTime] = endIso.split('T');
          el("event-date-end").value = eDate || '';
          el("event-time-end").value = (eTime||'').slice(0,5);
        } else {
          el("event-date-end").value = sDate || '';
          el("event-time-end").value = '';
        }
        el("event-time-start").value = (sTime||'').slice(0,5);
      }

      el("event-form").classList.remove("hidden");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await getRedirectResult(auth);
        if (res?.user) { authStatusEl.textContent = "Welcome, " + (res.user.email || ""); showStatus("Logged in with Google.", true); }
      } catch(e) { if (e?.message) showStatus(e.message, false); }

      // FullCalendar
      const calendarEl = document.getElementById("calendar");
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        headerToolbar: false,        // we render our own title/controls
        fixedWeekCount: true,        // always 6 weeks in month view
        height: "auto",
        navLinks: false,
        selectable: true,
        // show "Sun Aug 24" style headers in week/day
        dayHeaderContent: (arg) => {
          const type = calendar.view?.type;
          if (type === 'timeGridWeek' || type === 'timeGridDay') {
            const d = arg.date;
            const wd = d.toLocaleString(undefined, { weekday: 'short' });
            const m  = d.toLocaleString(undefined, { month: 'short' });
            const day= d.getDate();
            return `${wd} ${m} ${day}`;
          }
          return arg.text;
        },
        dateClick: (info) => {
          if (!auth.currentUser) { showStatus("Please log in to add events.", false); return; }
          el("event-id").value = "";
          el("event-title").value = "";
          el("event-date-start").value = info.dateStr;
          el("event-date-end").value = info.dateStr;
          el("event-time-start").value = "";
          el("event-time-end").value = "";
          el("event-form").classList.remove("hidden");
          // jump to day view if you clicked in week/day grid
          if (calendar.view.type === 'timeGridWeek') {
            calendar.changeView('timeGridDay', info.dateStr);
          }
        },
        eventClick: (info) => {
          // tap once to edit, long-press (or confirm) to delete â€“ weâ€™ll use an edit-first UX
          const ev = info.event;
          // Simple action sheet style confirm for delete
          const doEdit = confirm(`Edit "${ev.title}"?\n\n(Press Cancel to delete instead)`);
          if (doEdit) {
            openEditForm(ev);
          } else {
            if (confirm(`Delete "${ev.title}"?`)) {
              remove(ref(db, "events/" + ev.id))
                .then(()=> { ev.remove(); showStatus("Deleted.", true); })
                .catch((e)=> showStatus(e.message, false));
            }
          }
        },
        datesSet: (info) => updateTitle(info)
      });

      calendar.render();

      // Title navigation buttons
      el('btn-prev').addEventListener('click', () => calendar.prev());
      el('btn-next').addEventListener('click', () => calendar.next());
      el('btn-today').addEventListener('click', () => calendar.today());

      // Top toolbar buttons
      el('btn-refresh').addEventListener('click', () => loadEvents(true));
      el('btn-month').addEventListener('click', () => calendar.changeView('dayGridMonth'));
      el('btn-week').addEventListener('click', () => calendar.changeView('timeGridWeek'));
      el('btn-day').addEventListener('click', () => calendar.changeView('timeGridDay'));

      // Form buttons
      el('btn-save').addEventListener('click', saveEvent);
      el('btn-cancel').addEventListener('click', () => el('event-form').classList.add('hidden'));

      updateTitle(); // initial
    });

    // --- Auth handlers ---
    el("btn-signup").onclick = () => {
      const email = el("auth-email").value.trim();
      const password = el("auth-password").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((u) => { authStatusEl.textContent = "Signed up as " + (u.user.email || ""); showStatus("Signed up.", true); })
        .catch((e) => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };

    el("btn-login").onclick = () => {
      const email = el("auth-email").value.trim();
      const password = el("auth-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then((u) => { authStatusEl.textContent = "Welcome, " + (u.user.email || ""); showStatus("Logged in.", true); })
        .catch((e) => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };

    el("btn-google").onclick = async () => {
      try {
        if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else { await signInWithPopup(auth, googleProvider); showStatus("Logged in with Google.", true); }
      } catch (e) {
        if (e?.code === 'auth/popup-blocked') {
          try { await signInWithRedirect(auth, googleProvider); } catch (err) { showStatus(err.message, false); }
        } else showStatus(e.message, false);
      }
    };

    el("btn-logout").onclick = () => {
      signOut(auth).then(() => {
        authStatusEl.textContent = "Logged out.";
        showStatus("Logged out.", true);
        calendar.removeAllEvents();
        el("event-form").classList.add("hidden");
        el("toolbar").classList.add("hidden");
        el("cal-title-row").classList.add("hidden");
        el("signed-in-as").classList.add("hidden");
        el("auth-row").classList.remove("hidden");
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authStatusEl.textContent = "Welcome, " + (user.email || "");
        el("who").textContent = user.email || "";
        el("signed-in-as").classList.remove("hidden");
        el("toolbar").classList.remove("hidden");
        el("cal-title-row").classList.remove("hidden");
        el("auth-row").classList.add("hidden");
        loadEvents(true);
      } else {
        el("signed-in-as").classList.add("hidden");
        el("toolbar").classList.add("hidden");
        el("cal-title-row").classList.add("hidden");
        el("auth-row").classList.remove("hidden");
        calendar && calendar.removeAllEvents();
      }
    });
  </script>
</body>
</html>