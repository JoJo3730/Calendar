<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff"/>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; }
    *{ box-sizing:border-box; }
    body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin:0 auto; padding:16px; max-width:980px; }
    h1{ display:flex; align-items:center; gap:10px; margin:6px 0 8px; }
    #whoRow{ margin:4px 0 10px; color:#333; }

    .pill{ padding:12px 18px; border-radius:14px; border:1px solid #d0d0d0; background:#fff; font-size:16px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    #status{ margin:8px 0 10px; font-size:14px; display:none; }
    #status.ok{ color:var(--ok); display:block; }
    #status.err{ color:var(--err); display:block; }

    /* Auth */
    #auth-section.hidden{ display:none; }
    #auth-section input{ width:100%; padding:12px; font-size:16px; margin:6px 0; border:1px solid #d0d0d0; border-radius:10px; }

    /* Calendar UI */
    #whenTitle{ font-size:42px; line-height:1.05; font-weight:900; margin:10px 0 12px; }
    #calendar{ --fc-event-text-color:#fff; }
    .fc .fc-daygrid-day-number{ font-weight:700; }
    .fc .fc-event{ border:0; border-radius:10px; padding:2px 6px; }
    .fc .fc-timegrid-slot{ height:38px; }

    /* Form */
    #formCard{ background:#f7f8fb; border:1px solid #e6e8ef; border-radius:14px; padding:14px; margin:12px 0; }
    #formCard.hidden{ display:none; }
    label{ display:block; margin:10px 0 6px; font-weight:600; }
    input[type="text"],input[type="date"],input[type="time"]{ width:100%; padding:12px 10px; border:1px solid #d2d6e0; border-radius:10px; font-size:16px; background:#fff; }
    .actions{ display:flex; gap:10px; margin-top:12px; }
    .actions button{ flex:1; padding:14px; font-size:16px; border-radius:12px; border:1px solid #cfd8dc; background:#fff; }
    #btn-save{ background:#1976d2; color:#fff; border-color:#1976d2; }
    #btn-delete{ background:#ffe8ea; color:#b00020; border-color:#ffcdd2; display:none; }

    /* Footer */
    #version{ margin:18px 0 6px; text-align:center; color:#777; }
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <!-- Signed-in status / logout -->
  <div id="whoRow" class="row">
    <div>Signed in as <strong id="who">(not signed in)</strong></div>
    <div class="spacer"></div>
    <button id="btn-logout" class="pill" style="display:none;">Log Out</button>
  </div>

  <!-- Top controls -->
  <div class="row">
    <button id="btn-refresh" class="pill">Refresh</button>
    <button id="btn-month" class="pill">Month</button>
    <button id="btn-week"  class="pill">Week</button>
    <button id="btn-day"   class="pill">Day</button>
    <div class="spacer"></div>
    <button id="btn-prev" class="pill" aria-label="previous">â€¹</button>
    <button id="btn-today" class="pill">today</button>
    <button id="btn-next" class="pill" aria-label="next">â€º</button>
  </div>

  <div id="whenTitle"></div>

  <!-- Auth (hidden when logged in) -->
  <div id="auth-section" class="hidden">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="btn-signup" class="pill">Sign Up</button>
      <button id="btn-login"  class="pill">Log In</button>
    </div>
  </div>

  <div id="status"></div>

  <!-- Add/Edit form -->
  <div id="formCard" class="hidden">
    <input type="hidden" id="event-id">
    <label>Title</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <label>Start Date</label>
    <input type="date" id="event-date-start">

    <label>End Date (optional, inclusive)</label>
    <input type="date" id="event-date-end">

    <label>Start Time (optional)</label>
    <input type="time" id="event-time-start">

    <label>End Time (optional)</label>
    <input type="time" id="event-time-end">

    <div class="actions">
      <button id="btn-save">Save</button>
      <button id="btn-cancel">Cancel</button>
      <button id="btn-delete">Delete</button>
    </div>
  </div>

  <div id="calendar"></div>

  <div id="version">Version: %APP_VERSION% | Built: %BUILD_TIME%</div>

  <script type="module">
    /* ---------------- Firebase ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    /* ---------------- Helpers & UI ---------------- */
    const $ = id => document.getElementById(id);
    const statusEl = $('status');
    function showStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.classList.remove('ok','err');
      statusEl.classList.add(ok ? 'ok' : 'err');
      statusEl.style.display = 'block';
      setTimeout(()=> statusEl.style.display='none', ok?2200:5000);
    }

    function addDaysYMD(ymd, n){
      if(!ymd) return ymd;
      const d = new Date(ymd + "T00:00:00");
      d.setDate(d.getDate()+n);
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function toLocalISO(ymd, hm){ // returns local ISO string
      if(!ymd || !hm) return null;
      const [h,m] = hm.split(':').map(n=>parseInt(n,10));
      const d = new Date(ymd + "T00:00:00");
      d.setHours(h, m, 0, 0);
      return d.toISOString();
    }

    // Fixed colors per user email
    const USER_COLORS = {
      "josephandlori@hotmail.com": "#22c55e",  // green
      "carolinefrederick123@gmail.com": "#ef4444", // red
      "madimack95@gmail.com": "#a855f7", // violet
      "jasethompson860@gmail.com": "#3b82f6", // blue
      "jmtandlyt@gmail.com": "#06b6d4", // cyan
      "__default": "#7e57c2" // purple fallback
    };
    const colorFor = (email)=> USER_COLORS[email?.toLowerCase?.()] || USER_COLORS.__default;

    /* ---------------- Calendar ---------------- */
    let currentUser = null;
    let calendar;
    const LONG_PRESS_MS = 650;

    function updateWhenTitle(){
      const view = calendar?.view;
      if(!view){ $('whenTitle').textContent = ''; return; }
      if(view.type === 'dayGridMonth'){
        $('whenTitle').textContent = view.currentStart.toLocaleString(undefined,{month:'long', year:'numeric'});
      } else if (view.type.startsWith('timeGridWeek')) {
        const s=view.currentStart, e=new Date(view.currentEnd.getTime()-86400000);
        const fmt = new Intl.DateTimeFormat(undefined,{month:'short', day:'numeric'});
        $('whenTitle').textContent = `${fmt.format(s)} â€“ ${fmt.format(e)}, ${e.getFullYear()}`;
      } else {
        $('whenTitle').textContent = calendar.getDate().toLocaleString(undefined,{weekday:'long', month:'long', day:'numeric', year:'numeric'});
      }
    }

    function fcNormalize(ev){
      // Convert DB -> FullCalendar event
      // For all-day, store start as "YYYY-MM-DD" and end as exclusive (YYYY-MM-DD + 1)
      const hasTimes = !!(ev.startTime || ev.endTime) || (typeof ev.start === 'string' && ev.start.includes('T'));
      const allDay = !hasTimes;
      let start = ev.start;
      let end = ev.end;

      if(allDay){
        // if DB kept inclusive end, convert to exclusive for FC at render time
        if(end) end = addDaysYMD(end, 1);
      } else {
        // if DB stored separate date+time fields, combine
        if(ev.start && ev.startTime && !ev.start.includes('T')) start = `${ev.start}T${ev.startTime}:00`;
        if(ev.end && ev.endTime && !ev.end.includes('T'))       end   = `${ev.end}T${ev.endTime}:00`;
      }

      const color = ev.color || colorFor(ev.createdBy || ev.owner);
      return {
        id: ev.id,
        title: ev.title,
        start, end,
        allDay,
        backgroundColor: color,
        borderColor: color,
        textColor: '#fff',
        extendedProps: { createdBy: ev.createdBy || ev.owner || "" }
      };
    }

    async function loadEvents(showMessage=false){
      if(!currentUser) return;
      const snap = await get(ref(db, "events"));
      const data = snap.val() || {};
      const list = Object.values(data).map(fcNormalize);
      calendar.removeAllEvents();
      calendar.addEventSource(list);
      if(showMessage) showStatus(`Loaded ${list.length} event${list.length===1?'':'s'}.`, true);
      updateWhenTitle();
    }

    function wireCalendar(){
      calendar = new FullCalendar.Calendar($('calendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        firstDay: 0,
        height: 'auto',
        fixedWeekCount: true,
        showNonCurrentDates: true,

        datesSet(){ updateWhenTitle(); },

        dateClick(info){
          if(!currentUser){ showStatus("Please log in to add events."); return; }
          startNewEvent(info.dateStr);
        },

        eventClick(info){
          if(!currentUser){ showStatus("Please log in to edit/delete."); return; }
          startEditEvent(info.event);
        },

        // Long-press to delete quickly
        eventDidMount(arg){
          let t = null;
          const start = ()=>{
            if(!currentUser) return;
            t = setTimeout(async ()=>{
              t=null;
              if(confirm(`Delete "${arg.event.title || 'this event'}"?`)){
                try{
                  await remove(ref(db, "events/"+arg.event.id));
                  showStatus("Event deleted.", true);
                  await loadEvents(false);
                }catch(e){ showStatus(e.message||"Failed to delete."); }
              }
            }, LONG_PRESS_MS);
          };
          const cancel = ()=>{ if(t){ clearTimeout(t); t=null; } };

          arg.el.addEventListener('touchstart', start, {passive:true});
          arg.el.addEventListener('mousedown', start);
          arg.el.addEventListener('touchend', cancel);
          arg.el.addEventListener('touchmove', cancel);
          arg.el.addEventListener('mouseup', cancel);
          arg.el.addEventListener('mouseleave', cancel);
        },

        events: []
      });
      calendar.render();
      updateWhenTitle();
    }

    /* ---------------- Form logic (New/Edit/Delete) ---------------- */
    const btnDelete = $('btn-delete');

    function startNewEvent(dateStr){
      $('formCard').classList.remove('hidden');
      $('event-id').value = "";
      $('event-title').value = "";
      $('event-date-start').value = dateStr || "";
      $('event-date-end').value = dateStr || "";
      $('event-time-start').value = "";
      $('event-time-end').value = "";
      btnDelete.style.display = 'none';
    }

    function startEditEvent(fcEvent){
      $('formCard').classList.remove('hidden');
      $('event-id').value = fcEvent.id || "";
      $('event-title').value = fcEvent.title || "";

      if(fcEvent.allDay){
        // FC gives exclusive end for all-day; convert to inclusive for form
        $('event-date-start').value = fcEvent.startStr.slice(0,10);
        const inclusive = fcEvent.end ? fcEvent.endStr.slice(0,10) : fcEvent.startStr.slice(0,10);
        $('event-date-end').value = fcEvent.end ? addDaysYMD(inclusive, -1) : inclusive;
        $('event-time-start').value = "";
        $('event-time-end').value = "";
      } else {
        const s = fcEvent.start;
        $('event-date-start').value = s.toISOString().slice(0,10);
        $('event-time-start').value = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
        if(fcEvent.end){
          const e = fcEvent.end;
          $('event-date-end').value = e.toISOString().slice(0,10);
          $('event-time-end').value = `${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`;
        } else {
          $('event-date-end').value = $('event-date-start').value;
          $('event-time-end').value = "";
        }
      }

      btnDelete.style.display = 'block';
    }

    $('btn-save').onclick = async ()=>{
      if(!currentUser){ showStatus("Please log in to save."); return; }

      const id = $('event-id').value || Date.now().toString();
      const title = $('event-title').value.trim();
      const sd = $('event-date-start').value;
      const ed = $('event-date-end').value;
      const st = $('event-time-start').value;
      const et = $('event-time-end').value;

      if(!title || !sd){ showStatus("Title and start date are required."); return; }

      const createdBy = currentUser.email || "";
      const color = colorFor(createdBy);

      const obj = {
        id, title,
        createdBy, color
      };

      if(!st && !et){
        // all-day
        obj.start = sd;             // YYYY-MM-DD
        if(ed){ obj.end = ed; }     // inclusive in DB; FC will add +1 on render
      } else {
        // timed
        obj.start = st ? `${sd}T${st}` : `${sd}T00:00`;
        if(et){
          obj.end = `${ed || sd}T${et}`;
        } else if(ed){
          obj.end = `${ed}T${st || "00:00"}`;
        }
        obj.startTime = st || "";
        if(et) obj.endTime = et;
      }

      try{
        await set(ref(db, "events/"+id), obj);
        $('formCard').classList.add('hidden');
        showStatus("Saved!", true);
        await loadEvents(false);
      }catch(e){ showStatus(e.message || "Failed to save."); }
    };

    $('btn-delete').onclick = async ()=>{
      const id = $('event-id').value;
      if(!id) return;
      if(!confirm("Delete this event?")) return;
      try{
        await remove(ref(db, "events/"+id));
        $('formCard').classList.add('hidden');
        showStatus("Event deleted.", true);
        await loadEvents(false);
      }catch(e){ showStatus(e.message || "Failed to delete."); }
    };

    $('btn-cancel').onclick = ()=> $('formCard').classList.add('hidden');

    /* ---------------- Top buttons ---------------- */
    $('btn-month').onclick = ()=>{ calendar.changeView('dayGridMonth'); updateWhenTitle(); };
    $('btn-week').onclick  = ()=>{ calendar.changeView('timeGridWeek'); updateWhenTitle(); };
    $('btn-day').onclick   = ()=>{ calendar.changeView('timeGridDay'); updateWhenTitle(); };

    $('btn-prev').onclick  = ()=>{ calendar.prev(); updateWhenTitle(); };
    $('btn-next').onclick  = ()=>{ calendar.next(); updateWhenTitle(); };
    $('btn-today').onclick = ()=>{ calendar.today(); updateWhenTitle(); };

    $('btn-refresh').onclick = ()=> loadEvents(true);

    /* ---------------- Auth ---------------- */
    function setAuthUI(user){
      currentUser = user || null;
      $('who').textContent = user?.email || "(not signed in)";
      $('btn-logout').style.display = user ? 'inline-block' : 'none';
      $('auth-section').classList.toggle('hidden', !!user);
      if(user){
        $('formCard').classList.add('hidden');
        loadEvents(true);
      }else{
        calendar && calendar.removeAllEvents();
        updateWhenTitle();
      }
    }

    onAuthStateChanged(auth, setAuthUI);

    $('btn-signup').onclick = async ()=>{
      try{
        const email = $('auth-email').value.trim();
        const pass  = $('auth-password').value;
        await createUserWithEmailAndPassword(auth, email, pass);
        showStatus("Signed up.", true);
      }catch(e){ showStatus(e.message || "Sign up failed."); }
    };

    $('btn-login').onclick = async ()=>{
      try{
        const email = $('auth-email').value.trim();
        const pass  = $('auth-password').value;
        await signInWithEmailAndPassword(auth, email, pass);
        showStatus("Logged in.", true);
      }catch(e){ showStatus(e.message || "Login failed."); }
    };

    $('btn-logout').onclick = async ()=>{
      try{ await signOut(auth); showStatus("Logged out.", true); }
      catch(e){ showStatus(e.message || "Logout failed."); }
    };

    // boot
    wireCalendar();
  </script>
</body>
</html>