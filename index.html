<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA + meta -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root {
      --ok:#0a7a0a;
      --err:#b00020;
      --light:#f5f5f5;
      --border:#e2e2e2;
      --btn:#1363df;
      --btn-text:#fff;
    }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding:16px; color:#111; }
    h2 { margin:0 0 12px; }

    /* Auth */
    #auth-section input { width:100%; padding:10px; font-size:16px; margin:6px 0; box-sizing:border-box; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > button { flex:1; min-width:140px; }
    .hidden { display:none !important; }

    /* Status line */
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }

    /* Event form */
    #event-card { background:var(--light); border-radius:10px; padding:12px; margin:12px 0 10px; border:1px solid var(--border); }
    label { display:block; margin-top:10px; font-weight:600; }
    input[type="text"], input[type="date"], input[type="time"], button { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    .btn-row { display:flex; gap:10px; margin-top:12px; }
    .btn-primary { background:var(--btn); color:var(--btn-text); border:none; border-radius:8px; }
    .btn-secondary { background:#fff; border:1px solid var(--border); border-radius:8px; }
    .btn-danger { background:#e54848; color:#fff; border:none; border-radius:8px; }

    /* Single-row toolbar */
    #toolbar { display:flex; gap:8px; justify-content:center; margin:12px 0 10px; flex-wrap:wrap; }
    #toolbar button { flex:0 1 auto; min-width:110px; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; font-weight:600; }

    /* Calendar */
    #calendar { max-width:1000px; margin:0 auto; }
    .fc .fc-toolbar-title { font-size:1.6rem; }
    .fc-event { cursor:pointer; }

    /* Footer */
    .foot { text-align:center; color:#666; margin-top:14px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <h2>ðŸ‘ª Family Calendar</h2>

  <!-- Auth -->
  <div id="auth-section">
    <input type="email" id="auth-email" placeholder="Email" autocomplete="username">
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
    <div class="row">
      <button id="btn-signup" class="btn-secondary">Sign Up</button>
      <button id="btn-login" class="btn-secondary">Log In</button>
      <button id="btn-google" class="btn-secondary">Sign in with Google</button>
      <button id="btn-logout" class="btn-secondary">Log Out</button>
    </div>
    <p id="auth-status"></p>
  </div>

  <!-- Welcome + status -->
  <div id="welcome" class="hidden" style="margin:6px 0 8px; font-weight:600;"></div>
  <div id="status" class="hidden"></div>

  <!-- Add / Edit Event -->
  <div id="event-card" class="hidden">
    <div style="font-size:18px; font-weight:700; margin-bottom:6px;">Add / Edit Event</div>
    <input type="hidden" id="event-id">
    <label>Title:</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <div class="row">
      <div style="flex:1; min-width:160px;">
        <label>Start Date:</label>
        <input type="date" id="event-date-start">
      </div>
      <div style="flex:1; min-width:160px;">
        <label>End Date (optional, inclusive):</label>
        <input type="date" id="event-date-end">
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width:160px;">
        <label>Start Time (optional):</label>
        <input type="time" id="event-time-start">
      </div>
      <div style="flex:1; min-width:160px;">
        <label>End Time (optional):</label>
        <input type="time" id="event-time-end">
      </div>
    </div>

    <div class="btn-row">
      <button id="btn-save" class="btn-primary">Save</button>
      <button id="btn-cancel" class="btn-secondary">Cancel</button>
      <button id="btn-delete" class="btn-danger hidden">Delete</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div id="toolbar" class="hidden">
    <button id="btn-refresh">Refresh</button>
    <button id="btn-month">Month</button>
    <button id="btn-week">Week</button>
    <button id="btn-day">Day</button>
  </div>

  <div id="calendar"></div>

  <div class="foot">Version: v1.3.0</div>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    const el = id => document.getElementById(id);
    const statusEl = el('status');
    const authStatusEl = el('auth-status');
    const welcomeEl = el('welcome');

    function showStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','ok','err');
      statusEl.classList.add(ok ? 'ok' : 'err');
      setTimeout(() => statusEl.classList.add('hidden'), ok ? 2200 : 6000);
    }

    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    let calendar;

    function initCalendar() {
      calendar = new FullCalendar.Calendar(el("calendar"), {
        initialView: "dayGridMonth",
        height: "auto",
        contentHeight: "auto",

        /* Force full-month grid (never fewer than 5 rows; FC uses 6) */
        fixedWeekCount: true,
        showNonCurrentDates: true,

        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: ""
        },
        nowIndicator: true,
        selectable: false,

        dateClick: (info) => {
          calendar.changeView("timeGridDay", info.dateStr);
          if (!auth.currentUser) return;
          openFormForNew(info.dateStr);
        },
        eventClick: (info) => {
          info.preventDefault();
          if (!auth.currentUser) { showStatus("Please log in to edit.", false); return; }
          const e = info.event;
          populateFormFromEvent(e);
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      });
      calendar.render();
    }

    function openFormForNew(dateStr) {
      el("event-card").classList.remove("hidden");
      el("event-id").value = "";
      el("event-title").value = "";
      el("event-date-start").value = dateStr;
      el("event-date-end").value = dateStr;
      el("event-time-start").value = "";
      el("event-time-end").value = "";
      el("btn-delete").classList.add("hidden");
    }

    function populateFormFromEvent(ev) {
      el("event-card").classList.remove("hidden");
      el("btn-delete").classList.remove("hidden");

      el("event-id").value = ev.id;
      el("event-title").value = ev.title || "";

      const start = ev.start;
      const end = ev.end;

      el("event-date-start").value = toYMD(start);
      el("event-date-end").value = end ? toYMD(isAllDay(ev) ? new Date(end.getTime() - 86400000) : end) : toYMD(start);

      if (isAllDay(ev)) {
        el("event-time-start").value = "";
        el("event-time-end").value = "";
        calendar.changeView("dayGridMonth", toYMD(start));
      } else {
        el("event-time-start").value = toHM(start);
        el("event-time-end").value = end ? toHM(end) : "";
        calendar.changeView("timeGridDay", toYMD(start));
      }
    }

    function isAllDay(ev) {
      return ev.allDay === true || (!ev.start || (ev.start.getHours() === 0 && ev.start.getMinutes() === 0 && !ev.end));
    }

    function toYMD(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function toHM(d){ const h=String(d.getHours()).padStart(2,'0'),m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`; }
    function addDays(ymd, days){ const d=new Date(ymd+"T00:00:00"); d.setDate(d.getDate()+days); return toYMD(d); }

    function buildEventFromForm() {
      const id = el("event-id").value || Date.now().toString();
      const title = el("event-title").value.trim();
      const sDate = el("event-date-start").value;
      const eDateInc = el("event-date-end").value;
      const sTime = el("event-time-start").value;
      const eTime = el("event-time-end").value;

      if (!title || !sDate) { showStatus("Title and start date are required.", false); return null; }

      let startISO, endISO, allDay;

      if (sTime) {
        allDay = false;
        startISO = `${sDate}T${sTime}:00`;
        if (eDateInc && eTime) endISO = `${eDateInc}T${eTime}:00`;
        else if (eTime) endISO = `${sDate}T${eTime}:00`;
        else endISO = null;
      } else {
        allDay = true;
        startISO = sDate;
        const endInc = eDateInc && eDateInc >= sDate ? eDateInc : sDate;
        endISO = addDays(endInc, 1);
      }

      const ev = { id, title, start: startISO, allDay };
      if (endISO) ev.end = endISO;
      return ev;
    }

    async function loadEvents(showMsg) {
      if (!auth.currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const map = snap.val() || {};
        const events = Object.values(map).map(normalizeEvent).filter(Boolean);
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        if (showMsg) showStatus(`Loaded ${events.length} event(s).`, true);
      } catch (e) {
        console.error(e);
        showStatus(e.message || "Failed to load events.", false);
      }
    }
    function normalizeEvent(obj){ if(!obj||!obj.title||!obj.start) return null; return { id:obj.id||String(Date.now()), title:obj.title, start:obj.start, end:obj.end||null, allDay:!!obj.allDay }; }

    // Buttons
    el("btn-save").onclick = async () => {
      if (!auth.currentUser) { showStatus("Please log in to save.", false); return; }
      const ev = buildEventFromForm(); if (!ev) return;
      try {
        await set(ref(db, "events/" + ev.id), ev);
        el("event-card").classList.add("hidden");
        el("btn-delete").classList.add("hidden");
        await loadEvents(false);
        showStatus("Saved!", true);
      } catch (e) { showStatus(e.message, false); }
    };
    el("btn-cancel").onclick = () => { el("event-card").classList.add("hidden"); el("btn-delete").classList.add("hidden"); };
    el("btn-delete").onclick = async () => {
      const id = el("event-id").value; const title = el("event-title").value || "this event";
      if (!id) return; if (!confirm(`Delete "${title}"?`)) return;
      try { await remove(ref(db, "events/" + id)); el("event-card").classList.add("hidden"); el("btn-delete").classList.add("hidden"); await loadEvents(false); showStatus("Deleted.", true); }
      catch (e) { showStatus(e.message, false); }
    };
    el("btn-refresh").onclick = () => loadEvents(true);
    el("btn-month").onclick   = () => calendar.changeView("dayGridMonth");
    el("btn-week").onclick    = () => calendar.changeView("timeGridWeek");
    el("btn-day").onclick     = () => calendar.changeView("timeGridDay");

    // Auth
    el("btn-signup").onclick = () => {
      const email = el("auth-email").value.trim(); const password = el("auth-password").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(u => { authStatusEl.textContent = "Signed up as " + (u.user.email || ""); showStatus("Signed up.", true); })
        .catch(e => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };
    el("btn-login").onclick = () => {
      const email = el("auth-email").value.trim(); const password = el("auth-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(u => { authStatusEl.textContent = "Welcome, " + (u.user.email || ""); showStatus("Logged in.", true); })
        .catch(e => { authStatusEl.textContent = e.message; showStatus(e.message, false); });
    };
    const googleProvider = new GoogleAuthProvider();
    el("btn-google").onclick = async () => {
      try {
        if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else await signInWithPopup(auth, googleProvider);
      } catch (e) {
        if (e?.code === 'auth/popup-blocked') { try { await signInWithRedirect(auth, googleProvider); } catch (err) { showStatus(err.message, false); } }
        else showStatus(e.message, false);
      }
    };
    el("btn-logout").onclick = () => {
      signOut(auth).then(() => {
        showStatus("Logged out.", true);
        welcomeEl.classList.add("hidden");
        el("auth-section").classList.remove("hidden");
        el("event-card").classList.add("hidden");
        el("toolbar").classList.add("hidden");
        el("btn-delete").classList.add("hidden");
        calendar.removeAllEvents();
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        welcomeEl.textContent = `Welcome, ${user.email || ""}`;
        welcomeEl.classList.remove("hidden");
        el("auth-section").classList.add("hidden");
        el("toolbar").classList.remove("hidden");
        loadEvents(true);
      } else {
        welcomeEl.classList.add("hidden");
        el("auth-section").classList.remove("hidden");
        el("toolbar").classList.add("hidden");
        calendar && calendar.removeAllEvents();
      }
    });

    (async function start() {
      initCalendar();
      try { const res = await getRedirectResult(auth); if (res?.user) showStatus("Logged in with Google.", true); } catch {}
    })();
  </script>
</body>
</html>