<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <link rel="icon" type="image/png" href="family-icon-192x192.png"/>

  <style>
    :root{--ok:#0a7a0a;--err:#b00020}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;padding:16px;max-width:980px;margin:0 auto}
    h1{display:flex;align-items:center;gap:8px;margin:4px 0 8px}
    #authLine{margin:6px 0 10px;color:#333}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:12px 18px;border-radius:14px;border:1px solid #d0d0d0;background:#fff;font-size:18px}
    .smallbar{display:flex;gap:10px;align-items:center;margin:8px 0}
    .today{padding:10px 16px;border-radius:10px;background:#eef1f6;border:1px solid #ccd3e0}
    #whenTitle{font-size:44px;line-height:1.02;font-weight:900;margin:6px 0 12px}
    #calendar{--fc-event-text-color:#fff}
    .hidden{display:none}
    #status{margin:6px 0 10px;font-size:14px}
    #status.ok{color:var(--ok)} #status.err{color:var(--err)}
    /* form */
    #formCard{background:#f7f8fb;border:1px solid #e6e8ef;border-radius:14px;padding:14px;margin:10px 0}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input[type="text"],input[type="date"],input[type="time"]{width:100%;padding:12px 10px;border:1px solid #d2d6e0;border-radius:10px;font-size:16px;background:#fff}
    .actions{display:flex;gap:10px;margin-top:12px}
    button.primary{flex:1;padding:14px;border:0;border-radius:12px;background:#1976d2;color:#fff;font-size:18px}
    button.outline{flex:1;padding:14px;border:1px solid #cfd8dc;border-radius:12px;background:#fff;font-size:18px}
    /* logout bubble */
    #btn-logout{position:absolute;right:16px;top:14px}
    #version{margin:18px 0 6px;text-align:center;color:#777}
    /* fc tweaks */
    .fc .fc-daygrid-day-number{font-weight:700}
    .fc .fc-event{border:0;border-radius:10px;padding:2px 6px}
    .fc .fc-timegrid-slot{height:38px}
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <div id="authLine">Signed in as <span id="who"></span></div>

  <div class="row" id="topButtons">
    <button id="btn-refresh" class="pill">Refresh</button>
    <button id="btn-month"   class="pill">Month</button>
    <button id="btn-week"    class="pill">Week</button>
    <button id="btn-day"     class="pill">Day</button>
    <button id="btn-logout"  class="pill hidden">Log<br/>Out</button>
  </div>

  <div class="smallbar">
    <button id="btn-prev" class="pill" aria-label="previous">â€¹</button>
    <button id="btn-today" class="today">today</button>
    <button id="btn-next" class="pill" aria-label="next">â€º</button>
  </div>

  <div id="whenTitle"></div>

  <div id="status" class="hidden"></div>

  <!-- Add/Edit form -->
  <div id="formCard" class="hidden">
    <input type="hidden" id="event-id">
    <label>Title</label>
    <input type="text" id="event-title" placeholder="e.g., Vacation">

    <label>Start Date</label>
    <input type="date" id="event-date-start">

    <label>End Date (optional, inclusive)</label>
    <input type="date" id="event-date-end">

    <label>Start Time (optional)</label>
    <input type="time" id="event-time-start">

    <label>End Time (optional)</label>
    <input type="time" id="event-time-end">

    <div class="actions">
      <button id="btn-save" class="primary">Save</button>
      <button id="btn-cancel" class="outline">Cancel</button>
    </div>
  </div>

  <div id="calendar"></div>

  <div id="version">Version: %APP_VERSION% | Built: %BUILD_TIME%</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Firebase (use the same config you already have) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const google = new GoogleAuthProvider();

    // --- helpers ---
    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');
    const flash = (msg, ok=false)=>{
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','ok','err');
      statusEl.classList.add(ok?'ok':'err');
      setTimeout(()=>statusEl.classList.add('hidden'), ok?2200:4500);
    };
    const addDaysYMD = (ymd, n)=>{
      if(!ymd) return ymd;
      const d = new Date(ymd+"T00:00:00");
      d.setDate(d.getDate()+n);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };

    // --- user color palette ---
    const USER_COLORS = {
      "jmtandlyt@gmail.com":    "#8bc34a", // green
      "carolinefrederick123@gmail.com": "#ef5350", // red
      "madimack95@gmail.com":   "#ff80ab", // pink
      "jasethompson860@gmail.com": "#42a5f5", // blue
      "josephandlori@hotmail.com": "#ffca28", // amber
      "__default": "#7e57c2" // purple fallback
    };
    const colorFor = (email)=>USER_COLORS[email?.toLowerCase?.()]||USER_COLORS.__default;

    let currentUser = null;
    let calendar;

    // --- Calendar ---
    const LONG_PRESS_MS = 650;

    function updateTitle(){
      const view = calendar.view;
      if(view.type === 'dayGridMonth'){
        $('whenTitle').textContent = view.currentStart.toLocaleString(undefined,{month:'long', year:'numeric'});
      }else if(view.type.startsWith('timeGridWeek')){
        const s=view.currentStart, e=new Date(view.currentEnd.getTime()-86400000);
        const fmt = new Intl.DateTimeFormat(undefined,{month:'short', day:'numeric'});
        $('whenTitle').textContent = `${fmt.format(s)} â€“ ${fmt.format(e)}, ${e.getFullYear()}`;
      }else{
        $('whenTitle').textContent = calendar.getDate().toLocaleString(undefined,{weekday:'long', month:'long', day:'numeric', year:'numeric'});
      }
    }

    function eventToFc(e){
      const hasTimes = (e.startTime || e.endTime);
      const allDay = !hasTimes;
      const start = hasTimes ? `${e.start}T${(e.startTime||"00:00")}` : e.start;
      let end = e.end;
      if(hasTimes){
        if(e.end && e.endTime) end = `${e.end}T${e.endTime}`;
        else if(e.end) end = `${e.end}T${e.startTime||"00:00"}`;
      }else if(e.end){
        // FullCalendar wants exclusive end for all-day
        end = addDaysYMD(e.end,1);
      }
      return {
        id: e.id,
        title: e.title,
        start, end,
        allDay,
        backgroundColor: e.color || colorFor(e.createdBy) || "#7e57c2",
        borderColor: "transparent"
      };
    }

    async function loadEvents(showMsg=false){
      if(!currentUser) return;
      const snap = await get(ref(db,"events"));
      const data = snap.val()||{};
      const events = Object.values(data).map(eventToFc);
      calendar.removeAllEvents();
      calendar.addEventSource(events);
      if(showMsg) flash(`Loaded ${events.length} event${events.length===1?'':'s'}.`, true);
    }

    function showForm(e, dateStr){
      $('formCard').classList.remove('hidden');
      $('event-id').value   = e?.id || "";
      $('event-title').value= e?.title || "";
      $('event-date-start').value = e?.start || dateStr || "";
      $('event-date-end').value   = e?.end || "";
      $('event-time-start').value = e?.startTime || "";
      $('event-time-end').value   = e?.endTime || "";
    }

    async function saveEvent(){
      if(!currentUser){ flash("Please sign in.", false); return; }
      const id = $('event-id').value || Date.now().toString();
      const title = $('event-title').value.trim();
      const start = $('event-date-start').value;
      const end   = $('event-date-end').value;
      const startTime = $('event-time-start').value;
      const endTime   = $('event-time-end').value;
      if(!title || !start){ flash("Title and start date are required.", false); return; }

      const obj = {
        id, title, start,
        createdBy: currentUser.email,
        color: colorFor(currentUser.email)
      };
      if(end) obj.end = end;
      if(startTime) obj.startTime = startTime;
      if(endTime) obj.endTime = endTime;

      await set(ref(db,"events/"+id), obj);
      $('formCard').classList.add('hidden');
      flash("Saved!", true);
      await loadEvents(false);
    }

    function wireCalendar(){
      calendar = new FullCalendar.Calendar($('calendar'),{
        initialView: 'dayGridMonth',
        headerToolbar: false,
        firstDay: 0,
        height: 'auto',

        datesSet(){ updateTitle(); },

        dateClick(info){
          // open form w/ that date
          if(!currentUser){ flash("Please sign in to add events.", false); return; }
          showForm(null, info.dateStr);
        },

        eventClick(info){
          // open form to edit
          const e = info.event;
          const data = e.extendedProps || {};
          showForm({
            id:e.id,
            title:e.title,
            start:e.startStr.slice(0,10),
            end: data.allDay ? (data.end? data.end.slice(0,10):"") :
                 (e.end ? e.end.toISOString().slice(0,10) : (data.end? data.end.slice(0,10):"")),
            startTime: (e.allDay? "": (e.startStr.match(/T(\d{2}:\d{2})/)||[])[1]) || "",
            endTime:   (e.allDay? "": (e.end?.toISOString().match(/T(\d{2}:\d{2})/)||[])[1]) || "",
          });
        },

        // ðŸ”¥ Long-press to delete
        eventDidMount(arg){
          let t=null;
          const begin = ()=>{
            if(!currentUser) return;
            t = setTimeout(async ()=>{
              t=null;
              if(confirm(`Delete "${arg.event.title || 'this event'}"?`)){
                try{
                  await remove(ref(db, "events/"+arg.event.id));
                  flash("Event deleted.", true);
                  await loadEvents(false);
                }catch(e){ flash(e.message); }
              }
            }, LONG_PRESS_MS);
          };
          const cancel = ()=>{ if(t){clearTimeout(t); t=null;} };

          arg.el.addEventListener('touchstart', begin, {passive:true});
          arg.el.addEventListener('mousedown', begin);
          arg.el.addEventListener('touchend', cancel);
          arg.el.addEventListener('touchmove', cancel);
          arg.el.addEventListener('mouseup', cancel);
          arg.el.addEventListener('mouseleave', cancel);
        }
      });
      calendar.render();
      updateTitle();
    }

    // --- top buttons ---
    $('btn-month').onclick = ()=>{ calendar.changeView('dayGridMonth'); updateTitle(); };
    $('btn-week').onclick  = ()=>{ calendar.changeView('timeGridWeek'); updateTitle(); };
    $('btn-day').onclick   = ()=>{ calendar.changeView('timeGridDay'); updateTitle(); };
    $('btn-prev').onclick  = ()=>{ calendar.prev(); updateTitle(); };
    $('btn-next').onclick  = ()=>{ calendar.next(); updateTitle(); };
    $('btn-today').onclick = ()=>{ calendar.today(); updateTitle(); };
    $('btn-refresh').onclick = ()=> loadEvents(true);

    $('btn-save').onclick = saveEvent;
    $('btn-cancel').onclick = ()=> $('formCard').classList.add('hidden');

    $('btn-logout').onclick = async ()=>{
      try{ await signOut(auth); }catch(e){ flash(e.message); }
    };

    // --- auth state ---
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      $('who').textContent = user?.email || "(not signed in)";
      $('btn-logout').classList.toggle('hidden', !user);
      $('formCard').classList.toggle('hidden', !user);
      if(user){
        await loadEvents(true);
      }else{
        calendar && calendar.removeAllEvents();
        flash("Please sign in with Google from your previous login screen.", false);
      }
    });

    // boot
    wireCalendar();
  </script>
</body>
</html>