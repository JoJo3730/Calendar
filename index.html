<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ‘ª Family Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- PWA bits (optional) -->
  <meta name="theme-color" content="#ffffff"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <style>
    :root { --ok:#0a7a0a; --err:#b00020; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; padding: 16px; }
    h1 { margin: 0 0 12px; display:flex; align-items:center; gap:.5rem; }
    #auth-row { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 18px; }
    .btn { padding:10px 14px; border-radius:12px; border:1px solid #d0d0d0; background:#fff; font-size:16px; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .btn.danger { background:#ffe8ea; color:#b00020; border-color:#ffccd1; }
    .hidden { display:none !important; }
    #status { margin:8px 0; font-size:14px; }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }

    /* top controls */
    #topbar { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    #left-controls, #right-controls { display:flex; gap:10px; align-items:center; }
    #view-buttons { display:flex; gap:10px; }
    #signed-as { font-size:14px; opacity:.8; }

    /* simple form */
    #event-form { background:#f6f7f8; border:1px solid #e4e7eb; border-radius:12px; padding:12px; margin:12px 0; }
    #event-form.hidden { display:none; }
    label { display:block; font-weight:600; margin:8px 0 4px; }
    input[type="text"], input[type="date"], input[type="time"] { width:100%; padding:10px; box-sizing:border-box; font-size:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > * { flex:1; min-width:180px; }

    #calendar { margin-top:10px; }
    footer { margin:18px 0 8px; text-align:center; opacity:.65; font-size:12px; }
  </style>
</head>
<body>
  <h1>ðŸ‘ª Family Calendar</h1>

  <!-- Auth section -->
  <div id="auth-block">
    <div class="row">
      <input id="email" type="email" placeholder="Email" autocomplete="username">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password">
    </div>
    <div id="auth-row">
      <button id="btn-signup" class="btn">Sign Up</button>
      <button id="btn-login"  class="btn primary">Log In</button>
      <button id="btn-google" class="btn">Sign in with Google</button>
    </div>
  </div>

  <!-- Top bar (shown when logged in) -->
  <div id="topbar" class="hidden">
    <div id="left-controls">
      <div id="view-buttons">
        <button id="btn-refresh" class="btn">Refresh</button>
        <button id="btn-month"   class="btn">Month</button>
        <button id="btn-week"    class="btn">Week</button>
        <button id="btn-day"     class="btn">Day</button>
      </div>
    </div>

    <div id="right-controls">
      <span id="signed-as"></span>
      <button id="btn-logout" class="btn danger">Log Out</button>
    </div>
  </div>

  <div id="status" class="hidden"></div>

  <!-- Add/Edit form -->
  <div id="event-form" class="hidden">
    <input type="hidden" id="event-id">
    <div class="row">
      <div>
        <label>Title</label>
        <input id="title" type="text" placeholder="e.g., Vacation">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Start Date</label>
        <input id="start-date" type="date">
      </div>
      <div>
        <label>End Date (optional, inclusive)</label>
        <input id="end-date" type="date">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Start Time (optional)</label>
        <input id="start-time" type="time">
      </div>
      <div>
        <label>End Time (optional)</label>
        <input id="end-time" type="time">
      </div>
    </div>
    <div class="row">
      <button id="btn-save" class="btn primary">Save</button>
      <button id="btn-cancel" class="btn">Cancel</button>
    </div>
  </div>

  <div id="calendar"></div>

  <footer>Version: v1.x â€¢ Built from main</footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Your Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyB6dFxZiIuwfobxGRxcfaNsoUeDiDV_1dQ",
      authDomain: "familycalendar-1587d.firebaseapp.com",
      databaseURL: "https://familycalendar-1587d-default-rtdb.firebaseio.com",
      projectId: "familycalendar-1587d",
      storageBucket: "familycalendar-1587d.appspot.com",
      messagingSenderId: "667608245714",
      appId: "1:667608245714:web:fdcc88f2317992d4f1140b"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // -------- Fixed colors by user (email) --------
    const USER_COLORS = {
      "josephandlori@hotmail.com":  "#1E90FF", // DodgerBlue
      "carolinefrederick123@gmail.com": "#FF4500", // OrangeRed
      "madimack95@gmail.com": "#32CD32", // LimeGreen
      "jasethompson860@gmail.com": "#8A2BE2", // BlueViolet
      "jmtandlyt@gmail.com": "#FF1493" // DeepPink
    };
    const DEFAULT_COLOR = "#808080"; // fallback gray
    const colorForUser = (email) => USER_COLORS[email?.toLowerCase?.()] || DEFAULT_COLOR;

    // --------- helpers ----------
    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');
    function toast(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.className = ok ? 'ok' : 'err';
      statusEl.classList.remove('hidden');
      setTimeout(()=>statusEl.classList.add('hidden'), ok ? 2200 : 6000);
    }
    function toISODate(d){ // yyyy-mm-dd
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function addDaysISO(ymd, days){
      const d=new Date(ymd+"T00:00:00"); d.setDate(d.getDate()+days); return toISODate(d);
    }

    // ---------- FullCalendar setup ----------
    let calendar;
    document.addEventListener('DOMContentLoaded', async () => {
      // handle possible redirect login
      try { await getRedirectResult(auth); } catch(_) {}
      calendar = new FullCalendar.Calendar($('calendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        fixedWeekCount: true,      // always show 6 weeks in month grid
        showNonCurrentDates: true, // keep out-of-month dates visible
        dayMaxEventRows: 3,
        firstDay: 0, // Sun
        dateClick: (info) => {
          if (!auth.currentUser) { toast('Please log in to add events'); return; }
          $('event-form').classList.remove('hidden');
          $('event-id').value = '';
          $('title').value = '';
          $('start-date').value = info.dateStr;
          $('end-date').value   = info.dateStr;
          $('start-time').value = '';
          $('end-time').value   = '';
        },
        eventClick: (info) => {
          if (!auth.currentUser) return;
          // Load into form for edit instead of immediate delete
          const e = info.event;
          $('event-form').classList.remove('hidden');
          $('event-id').value = e.id;
          $('title').value = e.title;
          const start = e.allDay ? toISODate(e.start) : e.start.toISOString().slice(0,10);
          $('start-date').value = start;

          // inclusive end in our DB; FC may have exclusive end for all-day
          let endISO = e.extendedProps.endInclusive || (e.end ? e.end.toISOString().slice(0,10) : start);
          $('end-date').value = endISO;

          $('start-time').value = e.extendedProps.startTime || '';
          $('end-time').value   = e.extendedProps.endTime   || '';
        },
        // ensure hour labels compact in week/day
        views: {
          timeGridWeek: { dayHeaderFormat: { weekday:'short', day:'numeric' } },
          timeGridDay:  { dayHeaderFormat: { weekday:'long',  month:'short', day:'numeric' } }
        }
      });
      calendar.render();
    });

    // --------- Auth UI wiring ----------
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    $('btn-signup').onclick = async () => {
      try {
        const cred = await createUserWithEmailAndPassword(auth, $('email').value.trim(), $('password').value);
        toast('Signed up', true);
      } catch(e){ toast(e.message); }
    };

    $('btn-login').onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, $('email').value.trim(), $('password').value);
        toast('Logged in', true);
      } catch(e){ toast(e.message); }
    };

    $('btn-google').onclick = async () => {
      try {
        if (isIOS || isSafari) await signInWithRedirect(auth, googleProvider);
        else await signInWithPopup(auth, googleProvider);
      } catch(e){ toast(e.message); }
    };

    $('btn-logout').onclick = async () => {
      await signOut(auth);
      toast('Logged out', true);
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // show app controls
        $('auth-block').classList.add('hidden');
        $('topbar').classList.remove('hidden');
        $('signed-as').textContent = `Signed in as ${user.email}`;
        $('event-form').classList.add('hidden');
        loadEvents();
      } else {
        $('auth-block').classList.remove('hidden');
        $('topbar').classList.add('hidden');
        $('signed-as').textContent = '';
        $('event-form').classList.add('hidden');
        calendar && calendar.removeAllEvents();
      }
    });

    // --------- Buttons on topbar ----------
    $('btn-month').onclick  = ()=> calendar.changeView('dayGridMonth');
    $('btn-week').onclick   = ()=> calendar.changeView('timeGridWeek');
    $('btn-day').onclick    = ()=> calendar.changeView('timeGridDay');
    $('btn-refresh').onclick= ()=> loadEvents();

    // --------- Save / Cancel ----------
    $('btn-cancel').onclick = ()=> $('event-form').classList.add('hidden');

    $('btn-save').onclick = async () => {
      if (!auth.currentUser) { toast('Please log in to save'); return; }

      const id   = $('event-id').value || String(Date.now());
      const t    = $('title').value.trim();
      const sd   = $('start-date').value;
      const ed   = $('end-date').value;
      const st   = $('start-time').value; // "HH:MM" or ""
      const et   = $('end-time').value;

      if (!t || !sd) { toast('Title and start date are required'); return; }

      // Build shape for DB
      let allDay = (!st && !et);
      let payload = {
        id, title: t,
        allDay,
        userEmail: auth.currentUser.email || "",
        userUid:   auth.currentUser.uid || ""
      };

      if (allDay) {
        payload.start = sd;                       // "YYYY-MM-DD"
        payload.end   = ed ? addDaysISO(ed,1) : undefined; // store FC all-day exclusive end
        payload.endInclusive = ed || sd;          // keep inclusive for editing
      } else {
        // time-based event: use RFC3339 with local time (no TZ conversion issues for FC)
        const startISO = `${sd}T${st}:00`;
        payload.start = startISO;
        if (et) payload.end = `${ed || sd}T${et}:00`;
        if (ed) payload.endInclusive = ed;
        if (st) payload.startTime = st;
        if (et) payload.endTime   = et;
      }

      try {
        await set(ref(db, "events/"+id), payload);
        $('event-form').classList.add('hidden');
        toast('Saved!', true);
        await loadEvents();
      } catch(e){ toast(e.message); }
    };

    // --------- Load + colorize events ----------
    async function loadEvents(){
      if (!auth.currentUser) return;
      try {
        const snap = await get(ref(db, "events"));
        const data = snap.val() || {};
        const list = Object.values(data);

        const events = list.map(obj => {
          // normalize DB -> FC
          const email = obj.userEmail || '';
          const color = colorForUser(email);
          const base = {
            id: obj.id,
            title: obj.title,
            backgroundColor: color,
            borderColor: color,
            textColor: '#fff',
            extendedProps: {
              startTime: obj.startTime || '',
              endTime:   obj.endTime   || '',
              endInclusive: obj.endInclusive || ''
            }
          };

          if (obj.allDay || (typeof obj.start === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(obj.start))) {
            // all-day
            base.allDay = true;
            base.start  = obj.start;
            // if DB kept exclusive end, pass through; otherwise compute if we only stored inclusive
            if (obj.end) base.end = obj.end;
            else if (obj.endInclusive) base.end = addDaysISO(obj.endInclusive,1);
          } else {
            base.start = obj.start; // datetime string
            if (obj.end) base.end = obj.end;
          }
          return base;
        });

        calendar.removeAllEvents();
        calendar.addEventSource(events);
      } catch(e){ toast(e.message); }
    }
  </script>
</body>
</html>